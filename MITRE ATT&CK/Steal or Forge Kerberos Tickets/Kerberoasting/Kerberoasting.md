# Kerberoasting
## Origin
- Service accounts with weak passwords
- Passwords that don't expire
- Over-permissioned service accounts
- No elevated rights are required to get the service tickets and no traffic is sent to the target.
## Kerberos 101
- User logs on with username & password
	- Password converted to NTLM hash
	- A timestamp is encrypted with the hash and sent to the KDC
	- Sent as authenticator in the authentication ticket TGT request AS-REQ
- TGT is encrypted, signed, delivered to the user AS-REP
	- Only KRBTGT in the domain can open and read TGT data
- TGT presented to the DC when requesting TGS ticket TGS-REQ
	- The DC opens the TGT & validates PAC checksum
	- If DC can open the ticket & checksum check out, TGT - valid
- TGT is encrypted using the service accounts NTLM password hash and sent to user
	- sent to user as TGS-REP
- User connects to the server hosting the service on the appropriate port & present TGS (AP REQ)
	- Service opens TGS ticket using its NTLM password hash
- If mutual authentication is required by the client (rare) 
	- The service accepts all data in TGS ticet without communication to the DC
## Tips
- Enumerate all user accounts with the attribute “AdminCount” equal to ‘1’.
	- Active-Directory.ps1 > get-aduser -filter {AdminCount -eq 1} -prop * | select name,created,passwordlastset,lastlogondate
	- PowerView.ps1 > Get-NetUser -AdminCount | Select name,whencreated,pwdlastset,lastlogon
- Filter based on SPN type
    - AGPMServer: Often has full control rights to all GPOs.
    - MSSQL/MSSQLSvc: Admin rights to SQL server(s) which often has interesting data.
    - FIMService: Often has admin rights to multiple AD forests.
    - STS: VMWare SSO service which could provide backdoor VMWare access.
- Use Rubeus with the /tgtdeleg flag to specify that we want only RC4 encryption when requesting a new service ticket.
	- .\Rubeus.exe kerberoast /tgtdeleg /user:testspn /nowrap
## Tools used
- Impacket’s GetUserSPNs.py from a non-domain joined **Linux** host
- Combination of setspn.exe Windows binary, PowerShell, and Mimikatz.
- From **Windows**, utilizing tools such as PowerView, Rubeus, and other PowerShell scripts.
## Ways to perform
- From a non-domain joined Linux host using valid domain user credentials.
- From a domain-joined Linux host as root after retrieving the keytab file.
- From a domain-joined Windows host authenticated as a domain user.
- From a domain-joined Windows host with a shell in the context of a domain account.
- As SYSTEM on a domain-joined Windows host.
- From a non-domain joined Windows host using runas /netonly.

## Level of access required
- Account's cleartext password (or NTLM hash).
- A shell in the context of a domain user account.
- SYSTEM level access on a domain-joined host.

## Common msDS-SupportedEncryptionTypes
- RC4 (type 23) - $krb5tgs$23$*
- AES-128 (type 17) - $krb5tgs$17$*
- AES-256 (type 18) - $krb5tgs$18$*

## Continuing Onwards
- Access a host via RDP or WinRM as a local user or a local admin
- Authenticate to a remote host as an admin using a tool such as PsExec
- Gain access to a sensitive file share
- Gain SERVICE_NAME access to a host as a DBA user, which can then be leveraged to escalate privileges

## Mitigation
- Set a long and complex password or passphrase that does not appear in any word list
- Managed Service Accounts (MSA) where complex passwords rotates on set interval
- Group Managed Service Accounts (gMSA) where complex passwords rotates on set interval
- Accounts set up with LAPS
- Log Kerberos TGS ticket requests by selecting Audit Kerberos Service Ticket Operations within Group Policy.
- A third party product that provides password vaulting is also a solid solution for managing service account passwords.
## Detection
- Abnormal number TGS-REQ and TGS-REP requests and responses.
- event ID: 4769: A Kerberos service ticket was requested
- event ID: 4770: A Kerberos service ticket was renewed
- A large amount of 4769 event IDs from one account within a short period may indicate an attack.
- Creating a Kerberoast Service Account Honeypot 